<!--
SPDX-FileCopyrightText: 2019-2020 Intel Corporation

SPDX-License-Identifier: MIT
-->



<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Working Directly with VA API for Linux* &mdash; oneAPI Specification 1.0-rev-2 documentation</title>
  

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../../../_static/favicons.png"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/doctools.js"></script>
        <script src="../../../../_static/language_data.js"></script>
        <script src="../../../../_static/custom.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link rel="next" title="CQP HRD Mode Encoding" href="VPL_apnds_f.html" />
    <link rel="prev" title="Switchable Graphics and Multiple Monitors" href="VPL_apnds_d.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="https://oneapi.com" class="icon icon-home"> oneAPI Specification
          

          
            
            <img src="../../../../_static/oneAPI-rgb-rev-100.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                1.0-rev-2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../architecture.html">Software Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dpcpp/source/index.html">DPC++</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../oneDPL/source/index.html">oneDPL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../oneDNN/source/index.html">oneDNN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../oneCCL/source/index.html">oneCCL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../l0/source/index.html">Level Zero</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../oneDAL/source/index.html">oneDAL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../oneTBB/source/nested-index.html">oneTBB</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">oneVPL</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../architecture/index.html">Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../programming_guide/index.html">Programming Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../VPL_summary.html">Mandatory APIs and Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../API_ref/VPL_api_ref.html">oneVPL API Reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Versioning.html">oneVPL API Versioning</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Appendices</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="VPL_intel_media_sdk.html">oneVPL for Intel<sup>®</sup> Media Software Development Kit Users</a></li>
<li class="toctree-l3"><a class="reference internal" href="VPL_apnds_a.html">Configuration Parameter Constraints</a></li>
<li class="toctree-l3"><a class="reference internal" href="VPL_apnds_b.html">Multiple-segment Encoding</a></li>
<li class="toctree-l3"><a class="reference internal" href="VPL_apnds_c.html">Streaming and Video Conferencing Features</a></li>
<li class="toctree-l3"><a class="reference internal" href="VPL_apnds_d.html">Switchable Graphics and Multiple Monitors</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Working Directly with VA API for Linux*</a></li>
<li class="toctree-l3"><a class="reference internal" href="VPL_apnds_f.html">CQP HRD Mode Encoding</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../VPL_acronyms.html">Glossary</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../oneMKL/source/index.html">oneMKL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../contributors.html">Contributors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../versions.html">HTML and PDF Versions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notices.html">Legal Notices and Disclaimers</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">oneAPI Specification</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          <!--
SPDX-FileCopyrightText: 2019-2020 Intel Corporation

SPDX-License-Identifier: MIT
-->

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html">oneAPI Specification</a> &raquo;</li>
        
          
          <li><a href="../index.html">oneVPL</a> </li>
          
        
          
        
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            
              <a href="https://github.com/oneapi-src/oneapi-spec/blob/master/source/elements/oneVPL/source/appendix/VPL_apnds_e.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="working-directly-with-va-api-for-linux">
<h1>Working Directly with VA API for Linux*<a class="headerlink" href="#working-directly-with-va-api-for-linux" title="Permalink to this headline">¶</a></h1>
<p>Intel<sup>®</sup> Media Software Development Kit takes care of all memory and synchronization related operations in the VA API.
The application may need to extend Intel<sup>®</sup> Media Software Development Kit functionality by working directly
with the VA API for Linux*, for example to implement a customized external allocator.
This section describes basic memory management and synchronization techniques.</p>
<p>To create the VA surface pool, the application should call the vaCreateSurfaces
function:</p>
<div class="highlight-c++ notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">VASurfaceAttrib</span> <span class="n">attrib</span><span class="p">;</span>
<span class="n">attrib</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">VASurfaceAttribPixelFormat</span><span class="p">;</span>
<span class="n">attrib</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">VAGenericValueTypeInteger</span><span class="p">;</span>
<span class="n">attrib</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">i</span> <span class="o">=</span> <span class="n">VA_FOURCC_NV12</span><span class="p">;</span>
<span class="n">attrib</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">VA_SURFACE_ATTRIB_SETTABLE</span><span class="p">;</span>

<span class="cp">#define NUM_SURFACES 5;</span>
<span class="n">VASurfaceID</span> <span class="n">surfaces</span><span class="p">[</span><span class="n">NUMSURFACES</span><span class="p">];</span>

<span class="n">vaCreateSurfaces</span><span class="p">(</span><span class="n">va_display</span><span class="p">,</span> <span class="n">VA_RT_FORMAT_YUV420</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">surfaces</span><span class="p">,</span> <span class="n">NUM_SURFACES</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attrib</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
<p>To destroy the surface pool, the application should call the vaDestroySurfaces
function:</p>
<div class="highlight-c++ notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">vaDestroySurfaces</span><span class="p">(</span><span class="n">va_display</span><span class="p">,</span> <span class="n">surfaces</span><span class="p">,</span> <span class="n">NUM_SURFACES</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
<p>If the application works with hardware acceleration through Intel<sup>®</sup> Media Software Development Kit, then it can
access surface data immediately after successful completion of
the <a class="reference internal" href="../API_ref/VPL_func_vidcore.html#_CPPv426MFXVideoCORE_SyncOperation10mfxSession12mfxSyncPoint6mfxU32" title="MFXVideoCORE_SyncOperation"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">MFXVideoCORE_SyncOperation()</span></code></a> call. If the application works with
hardware acceleration directly, then it must check surface status before
accessing data in video memory. This check can be done asynchronously by calling
the vaQuerySurfaceStatus function or synchronously by calling the vaSyncSurface
function.</p>
<p>After successful synchronization, the application can access surface data.
Accessing surface data is performed in two steps:</p>
<ol class="arabic simple">
<li><p>Create VAImage from surface.</p></li>
<li><p>Map image buffer to system memory.</p></li>
</ol>
<p>After mapping, the VAImage.offsets[3] array holds offsets to each color
plain in a mapped buffer and the VAImage.pitches[3] array holds color plain
pitches in bytes. For packed data formats, only first entries in these
arrays are valid. The following example shows how to access data in a NV12 surface:</p>
<div class="highlight-c++ notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">VAImage</span> <span class="n">image</span><span class="p">;</span>
<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">V</span><span class="p">;</span>

<span class="n">vaDeriveImage</span><span class="p">(</span><span class="n">va_display</span><span class="p">,</span> <span class="n">surface_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">image</span><span class="p">);</span>
<span class="n">vaMapBuffer</span><span class="p">(</span><span class="n">va_display</span><span class="p">,</span> <span class="n">image</span><span class="p">.</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">);</span>

<span class="cm">/* NV12 */</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">buffer</span> <span class="o">+</span> <span class="n">image</span><span class="p">.</span><span class="n">offsets</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">buffer</span> <span class="o">+</span> <span class="n">image</span><span class="p">.</span><span class="n">offsets</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="n">V</span> <span class="o">=</span> <span class="n">U</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</pre></div>
</td></tr></table></div>
<p>After processing data in a VA surface, the application should release resources
allocated for the mapped buffer and VAImage object:</p>
<div class="highlight-c++ notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">vaUnmapBuffer</span><span class="p">(</span><span class="n">va_display</span><span class="p">,</span> <span class="n">image</span><span class="p">.</span><span class="n">buf</span><span class="p">);</span>
<span class="n">vaDestroyImage</span><span class="p">(</span><span class="n">va_display</span><span class="p">,</span> <span class="n">image</span><span class="p">.</span><span class="n">image_id</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
<p>In some cases, in order to retrieve encoded bitstream data from video memory,
the application must use the VABuffer to store data. The following example shows
how to create, use, and destroy the VABuffer:</p>
<div class="highlight-c++ notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cm">/* create buffer */</span>
<span class="n">VABufferID</span> <span class="n">buf_id</span><span class="p">;</span>
<span class="n">vaCreateBuffer</span><span class="p">(</span><span class="n">va_display</span><span class="p">,</span> <span class="n">va_context</span><span class="p">,</span> <span class="n">VAEncCodedBufferType</span><span class="p">,</span> <span class="n">buf_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span> <span class="n">buf_id</span><span class="p">);</span>

<span class="cm">/* encode frame */</span>
<span class="c1">// ...</span>

<span class="cm">/* map buffer */</span>
<span class="n">VACodedBufferSegment</span> <span class="o">*</span><span class="n">coded_buffer_segment</span><span class="p">;</span>

<span class="n">vaMapBuffer</span><span class="p">(</span><span class="n">va_display</span><span class="p">,</span> <span class="n">buf_id</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)(</span><span class="o">&amp;</span> <span class="n">coded_buffer_segment</span><span class="p">));</span>

<span class="n">size</span>   <span class="o">=</span> <span class="n">coded_buffer_segment</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
<span class="n">offset</span> <span class="o">=</span> <span class="n">coded_buffer_segment</span><span class="o">-&gt;</span><span class="n">bit_offset</span><span class="p">;</span>
<span class="n">buf</span>    <span class="o">=</span> <span class="n">coded_buffer_segment</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span>

<span class="cm">/* retrieve encoded data*/</span>
<span class="c1">// ...</span>

<span class="cm">/* unmap and destroy buffer */</span>
<span class="n">vaUnmapBuffer</span><span class="p">(</span><span class="n">va_display</span><span class="p">,</span> <span class="n">buf_id</span><span class="p">);</span>
<span class="n">vaDestroyBuffer</span><span class="p">(</span><span class="n">va_display</span><span class="p">,</span> <span class="n">buf_id</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
<p>Note that the vaMapBuffer function returns pointers to different objects
depending on the mapped buffer type. The VAImage is a plain data buffer and the
encoded bitstream is a VACodedBufferSegment structure. The application cannot use
VABuffer for synchronization. If encoding, it is recommended to synchronize
using the VA surface as described above.</p>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="VPL_apnds_f.html" class="btn btn-neutral float-right" title="CQP HRD Mode Encoding" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="VPL_apnds_d.html" class="btn btn-neutral float-left" title="Switchable Graphics and Multiple Monitors" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, Intel Corporation

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>
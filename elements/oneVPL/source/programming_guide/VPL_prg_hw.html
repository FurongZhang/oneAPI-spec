

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Hardware Acceleration &mdash; oneAPI Specification 1.0 documentation</title>
  

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../../../_static/favicons.png"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/doctools.js"></script>
        <script src="../../../../_static/language_data.js"></script>
        <script src="../../../../_static/custom.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link rel="next" title="Memory Allocation and External Allocators" href="VPL_prg_mem.html" />
    <link rel="prev" title="Transcoding Procedures" href="VPL_prg_transcoding.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="https://oneapi.com" class="icon icon-home"> oneAPI Specification
          

          
            
            <img src="../../../../_static/oneAPI-rgb-rev-100.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../../architecture.html">Software Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../library-interop.html">Library Interoperability</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../elements.html">oneAPI Elements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dpcpp/source/index.html">DPC++</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../oneDPL/source/index.html">oneDPL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../oneDNN/source/index.html">oneDNN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../oneCCL/source/index.html">oneCCL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../l0/source/index.html">Level Zero</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../oneDAL/source/index.html">oneDAL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../oneTBB/source/nested-index.html">oneTBB</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">oneVPL</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../architecture/index.html">Architecture</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Programming Guide</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="VPL_prg_stc.html">Status Codes</a></li>
<li class="toctree-l3"><a class="reference internal" href="VPL_prg_session.html">oneVPL Session</a></li>
<li class="toctree-l3"><a class="reference internal" href="VPL_prg_frame.html">Frame and Fields</a></li>
<li class="toctree-l3"><a class="reference internal" href="VPL_prg_decoding.html">Decoding Procedures</a></li>
<li class="toctree-l3"><a class="reference internal" href="VPL_prg_encoding.html">Encoding Procedures</a></li>
<li class="toctree-l3"><a class="reference internal" href="VPL_prg_vpp.html">Video Processing Procedures</a></li>
<li class="toctree-l3"><a class="reference internal" href="VPL_prg_transcoding.html">Transcoding Procedures</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Hardware Acceleration</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#new-model-to-work-with-hardware-acceleration">New Model to Work with Hardware Acceleration</a></li>
<li class="toctree-l4"><a class="reference internal" href="#work-with-hardware-acceleration-in-legacy-mode">Work with Hardware Acceleration in Legacy Mode</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="VPL_prg_mem.html">Memory Allocation and External Allocators</a></li>
<li class="toctree-l3"><a class="reference internal" href="VPL_prg_err.html">Hardware Device Error Handling</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../VPL_summary.html">Mandatory APIs and Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../API_ref/VPL_api_ref.html">oneVPL API Reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Versioning.html">oneVPL API Versioning</a></li>
<li class="toctree-l2"><a class="reference internal" href="../appendix/index.html">Appendices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../VPL_acronyms.html">Glossary</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../oneMKL/source/index.html">oneMKL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../contributors.html">Contributors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../versions.html">HTML and PDF Versions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notices.html">Legal Notices and Disclaimers</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">oneAPI Specification</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html">oneAPI Specification</a> &raquo;</li>
        
          
          <li><a href="../index.html">oneVPL</a> </li>
          
        
          
        
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            
              <a href="https://github.com/oneapi-src/oneapi-spec/blob/master/source/elements/oneVPL/source/programming_guide/VPL_prg_hw.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="hardware-acceleration">
<span id="hw-acceleration"></span><h1>Hardware Acceleration<a class="headerlink" href="#hardware-acceleration" title="Permalink to this headline">¶</a></h1>
<p>oneVPL provides a new model for working with hardware acceleration while
continuing to support hardware acceleration in legacy mode.</p>
<div class="section" id="new-model-to-work-with-hardware-acceleration">
<h2>New Model to Work with Hardware Acceleration<a class="headerlink" href="#new-model-to-work-with-hardware-acceleration" title="Permalink to this headline">¶</a></h2>
<p>oneVPL API version 2.0 introduces a new memory model: internal allocation where
oneVPL is responsible for video memory allocation. In this mode,
an application is not dependent on a low-level video framework API, such as
DirectX* or the VA API, and does not need to create and set corresponding
low-level oneVPL primitives such as <cite>ID3D11Device</cite> or <cite>VADisplay</cite>. Instead,
oneVPL creates all required objects to work with hardware acceleration and video
surfaces internally. An application can get access to these objects using
<a class="reference internal" href="../API_ref/VPL_func_vidcore.html#_CPPv422MFXVideoCORE_GetHandle10mfxSession13mfxHandleTypeP6mfxHDL" title="MFXVideoCORE_GetHandle"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">MFXVideoCORE_GetHandle()</span></code></a> or with help of the
<a class="reference internal" href="../API_ref/VPL_structs_memory.html#_CPPv424mfxFrameSurfaceInterface" title="mfxFrameSurfaceInterface"><code class="xref cpp cpp-struct docutils literal notranslate"><span class="pre">mfxFrameSurfaceInterface</span></code></a> interface.</p>
<p>This approach simplifies the oneVPL initialization, making calls to the
<a class="reference internal" href="../API_ref/VPL_func_vid_encode.html#_CPPv426MFXVideoENCODE_QueryIOSurf10mfxSessionP13mfxVideoParamP20mfxFrameAllocRequest" title="MFXVideoENCODE_QueryIOSurf"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">MFXVideoENCODE_QueryIOSurf()</span></code></a>, <a class="reference internal" href="../API_ref/VPL_func_vid_decode.html#_CPPv426MFXVideoDECODE_QueryIOSurf10mfxSessionP13mfxVideoParamP20mfxFrameAllocRequest" title="MFXVideoDECODE_QueryIOSurf"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">MFXVideoDECODE_QueryIOSurf()</span></code></a>,
or <a class="reference internal" href="../API_ref/VPL_func_vid_vpp.html#_CPPv423MFXVideoVPP_QueryIOSurf10mfxSessionP13mfxVideoParamAL2E_20mfxFrameAllocRequest" title="MFXVideoVPP_QueryIOSurf"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">MFXVideoVPP_QueryIOSurf()</span></code></a> functions optional. See
<a class="reference internal" href="VPL_prg_mem.html#internal-mem-manage"><span class="std std-ref">Internal Memory Management</span></a>.</p>
</div>
<div class="section" id="work-with-hardware-acceleration-in-legacy-mode">
<h2>Work with Hardware Acceleration in Legacy Mode<a class="headerlink" href="#work-with-hardware-acceleration-in-legacy-mode" title="Permalink to this headline">¶</a></h2>
<div class="section" id="work-with-multiple-media-devices">
<h3>Work with Multiple Media Devices<a class="headerlink" href="#work-with-multiple-media-devices" title="Permalink to this headline">¶</a></h3>
<p>If your system has multiple graphics adapters, you may need hints on which
adapter is better suited to process a particular workload. The legacy mode of
oneVPL provides a helper API to select the most suitable adapter for your
workload based on the provided workload description. The following example shows
workload initialization on a discrete adapter:</p>
<div class="highlight-c++ notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">mfxU32</span> <span class="n">num_adapters_available</span><span class="p">;</span>
<span class="n">mfxIMPL</span> <span class="n">impl</span><span class="p">;</span>

<span class="c1">// Query number of graphics adapters available on system</span>
<span class="n">mfxStatus</span> <span class="n">sts</span> <span class="o">=</span> <span class="n">MFXQueryAdaptersNumber</span><span class="p">(</span><span class="o">&amp;</span><span class="n">num_adapters_available</span><span class="p">);</span>
<span class="n">MSDK_CHECK_STATUS</span><span class="p">(</span><span class="n">sts</span><span class="p">,</span> <span class="s">&quot;MFXQueryAdaptersNumber failed&quot;</span><span class="p">);</span>

<span class="c1">// Allocate memory for response</span>
<span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">mfxAdapterInfo</span><span class="o">&gt;</span> <span class="n">displays_data</span><span class="p">(</span><span class="n">num_adapters_available</span><span class="p">);</span>
<span class="n">mfxAdaptersInfo</span> <span class="n">adapters</span> <span class="o">=</span> <span class="p">{</span> <span class="n">displays_data</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">mfxU32</span><span class="p">(</span><span class="n">displays_data</span><span class="p">.</span><span class="n">size</span><span class="p">()),</span> <span class="mi">0u</span> <span class="p">};</span>

<span class="c1">// Query information about all adapters (mind that first parameter is NULL)</span>
<span class="n">sts</span> <span class="o">=</span> <span class="n">MFXQueryAdapters</span><span class="p">(</span><span class="k">nullptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapters</span><span class="p">);</span>
<span class="n">MSDK_CHECK_STATUS</span><span class="p">(</span><span class="n">sts</span><span class="p">,</span> <span class="s">&quot;MFXQueryAdapters failed&quot;</span><span class="p">);</span>

<span class="c1">// Find dGfx adapter in list of adapters</span>
<span class="k">auto</span> <span class="n">idx_d</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">find_if</span><span class="p">(</span><span class="n">adapters</span><span class="p">.</span><span class="n">Adapters</span><span class="p">,</span> <span class="n">adapters</span><span class="p">.</span><span class="n">Adapters</span> <span class="o">+</span> <span class="n">adapters</span><span class="p">.</span><span class="n">NumActual</span><span class="p">,</span>
    <span class="p">[](</span><span class="k">const</span> <span class="n">mfxAdapterInfo</span> <span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
   <span class="k">return</span> <span class="n">info</span><span class="p">.</span><span class="n">Platform</span><span class="p">.</span><span class="n">MediaAdapterType</span> <span class="o">==</span> <span class="n">mfxMediaAdapterType</span><span class="o">::</span><span class="n">MFX_MEDIA_DISCRETE</span><span class="p">;</span>
<span class="p">});</span>

<span class="c1">// No dGfx in list</span>
<span class="k">if</span> <span class="p">(</span><span class="n">idx_d</span> <span class="o">==</span> <span class="n">adapters</span><span class="p">.</span><span class="n">Adapters</span> <span class="o">+</span> <span class="n">adapters</span><span class="p">.</span><span class="n">NumActual</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Warning: No dGfx detected on machine</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
   <span class="k">return</span> <span class="mi">-1</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">mfxU32</span> <span class="n">idx</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">mfxU32</span><span class="o">&gt;</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">distance</span><span class="p">(</span><span class="n">adapters</span><span class="p">.</span><span class="n">Adapters</span><span class="p">,</span> <span class="n">idx_d</span><span class="p">));</span>

<span class="c1">// Choose correct implementation for discrete adapter</span>
<span class="k">switch</span> <span class="p">(</span><span class="n">adapters</span><span class="p">.</span><span class="n">Adapters</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">Number</span><span class="p">)</span>
<span class="p">{</span>
<span class="k">case</span> <span class="mi">0</span><span class="o">:</span>
   <span class="n">impl</span> <span class="o">=</span> <span class="n">MFX_IMPL_HARDWARE</span><span class="p">;</span>
   <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
   <span class="n">impl</span> <span class="o">=</span> <span class="n">MFX_IMPL_HARDWARE2</span><span class="p">;</span>
   <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mi">2</span><span class="o">:</span>
   <span class="n">impl</span> <span class="o">=</span> <span class="n">MFX_IMPL_HARDWARE3</span><span class="p">;</span>
   <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mi">3</span><span class="o">:</span>
   <span class="n">impl</span> <span class="o">=</span> <span class="n">MFX_IMPL_HARDWARE4</span><span class="p">;</span>
   <span class="k">break</span><span class="p">;</span>

<span class="k">default</span><span class="o">:</span>
   <span class="c1">// Try searching on all display adapters</span>
   <span class="n">impl</span> <span class="o">=</span> <span class="n">MFX_IMPL_HARDWARE_ANY</span><span class="p">;</span>
   <span class="k">break</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Initialize mfxSession in regular way with obtained implementation</span>
</pre></div>
</td></tr></table></div>
<p>The example shows that after obtaining the adapter list with
<a class="reference internal" href="../API_ref/VPL_func_adapters.html#_CPPv416MFXQueryAdaptersP16mfxComponentInfoP15mfxAdaptersInfo" title="MFXQueryAdapters"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">MFXQueryAdapters()</span></code></a>, further initialization of <a class="reference internal" href="../API_ref/VPL_ref_types.html#_CPPv410mfxSession" title="mfxSession"><code class="xref cpp cpp-type docutils literal notranslate"><span class="pre">mfxSession</span></code></a>
is performed in the regular way. The specific adapter is selected using
the <a class="reference internal" href="../API_ref/VPL_enums.html#_CPPv417MFX_IMPL_HARDWARE" title="MFX_IMPL_HARDWARE"><code class="xref cpp cpp-enumerator docutils literal notranslate"><span class="pre">MFX_IMPL_HARDWARE</span></code></a>, <a class="reference internal" href="../API_ref/VPL_enums.html#_CPPv418MFX_IMPL_HARDWARE2" title="MFX_IMPL_HARDWARE2"><code class="xref cpp cpp-enumerator docutils literal notranslate"><span class="pre">MFX_IMPL_HARDWARE2</span></code></a>,
<a class="reference internal" href="../API_ref/VPL_enums.html#_CPPv418MFX_IMPL_HARDWARE3" title="MFX_IMPL_HARDWARE3"><code class="xref cpp cpp-enumerator docutils literal notranslate"><span class="pre">MFX_IMPL_HARDWARE3</span></code></a>, or <a class="reference internal" href="../API_ref/VPL_enums.html#_CPPv418MFX_IMPL_HARDWARE4" title="MFX_IMPL_HARDWARE4"><code class="xref cpp cpp-enumerator docutils literal notranslate"><span class="pre">MFX_IMPL_HARDWARE4</span></code></a>
values of <a class="reference internal" href="../API_ref/VPL_enums.html#_CPPv47mfxIMPL" title="mfxIMPL"><code class="xref cpp cpp-type docutils literal notranslate"><span class="pre">mfxIMPL</span></code></a>.</p>
<p>The following example shows the use of <a class="reference internal" href="../API_ref/VPL_func_adapters.html#_CPPv416MFXQueryAdaptersP16mfxComponentInfoP15mfxAdaptersInfo" title="MFXQueryAdapters"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">MFXQueryAdapters()</span></code></a> for querying
the most suitable adapter for a particular encode workload:</p>
<div class="highlight-c++ notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">mfxU32</span> <span class="n">num_adapters_available</span><span class="p">;</span>
<span class="n">mfxIMPL</span> <span class="n">impl</span><span class="p">;</span>
<span class="n">mfxVideoParam</span> <span class="n">Encode_mfxVideoParam</span><span class="p">;</span>

<span class="c1">// Query number of graphics adapters available on system</span>
<span class="n">mfxStatus</span> <span class="n">sts</span> <span class="o">=</span> <span class="n">MFXQueryAdaptersNumber</span><span class="p">(</span><span class="o">&amp;</span><span class="n">num_adapters_available</span><span class="p">);</span>
<span class="n">MSDK_CHECK_STATUS</span><span class="p">(</span><span class="n">sts</span><span class="p">,</span> <span class="s">&quot;MFXQueryAdaptersNumber failed&quot;</span><span class="p">);</span>

<span class="c1">// Allocate memory for response</span>
<span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">mfxAdapterInfo</span><span class="o">&gt;</span> <span class="n">displays_data</span><span class="p">(</span><span class="n">num_adapters_available</span><span class="p">);</span>
<span class="n">mfxAdaptersInfo</span> <span class="n">adapters</span> <span class="o">=</span> <span class="p">{</span> <span class="n">displays_data</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">mfxU32</span><span class="p">(</span><span class="n">displays_data</span><span class="p">.</span><span class="n">size</span><span class="p">()),</span> <span class="mi">0u</span> <span class="p">};</span>

<span class="c1">// Fill description of Encode workload</span>
<span class="n">mfxComponentInfo</span> <span class="n">interface_request</span> <span class="o">=</span> <span class="p">{</span> <span class="n">MFX_COMPONENT_ENCODE</span><span class="p">,</span> <span class="n">Encode_mfxVideoParam</span> <span class="p">};</span>

<span class="c1">// Query information about suitable adapters for Encode workload described by Encode_mfxVideoParam</span>
<span class="n">sts</span> <span class="o">=</span> <span class="n">MFXQueryAdapters</span><span class="p">(</span><span class="o">&amp;</span><span class="n">interface_request</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapters</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="n">sts</span> <span class="o">==</span> <span class="n">MFX_ERR_NOT_FOUND</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Error: No adapters on machine capable to process desired workload</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
   <span class="k">return</span> <span class="mi">-1</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">MSDK_CHECK_STATUS</span><span class="p">(</span><span class="n">sts</span><span class="p">,</span> <span class="s">&quot;MFXQueryAdapters failed&quot;</span><span class="p">);</span>

<span class="c1">// Choose correct implementation for discrete adapter. Mind usage of index 0, this is best suitable adapter from MSDK perspective</span>
<span class="k">switch</span> <span class="p">(</span><span class="n">adapters</span><span class="p">.</span><span class="n">Adapters</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">Number</span><span class="p">)</span>
<span class="p">{</span>
<span class="k">case</span> <span class="mi">0</span><span class="o">:</span>
   <span class="n">impl</span> <span class="o">=</span> <span class="n">MFX_IMPL_HARDWARE</span><span class="p">;</span>
   <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
   <span class="n">impl</span> <span class="o">=</span> <span class="n">MFX_IMPL_HARDWARE2</span><span class="p">;</span>
   <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mi">2</span><span class="o">:</span>
   <span class="n">impl</span> <span class="o">=</span> <span class="n">MFX_IMPL_HARDWARE3</span><span class="p">;</span>
   <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mi">3</span><span class="o">:</span>
   <span class="n">impl</span> <span class="o">=</span> <span class="n">MFX_IMPL_HARDWARE4</span><span class="p">;</span>
   <span class="k">break</span><span class="p">;</span>

<span class="k">default</span><span class="o">:</span>
   <span class="c1">// Try searching on all display adapters</span>
   <span class="n">impl</span> <span class="o">=</span> <span class="n">MFX_IMPL_HARDWARE_ANY</span><span class="p">;</span>
   <span class="k">break</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Initialize mfxSession in regular way with obtained implementation</span>
</pre></div>
</td></tr></table></div>
<p>See the <a class="reference internal" href="../API_ref/VPL_func_adapters.html#_CPPv416MFXQueryAdaptersP16mfxComponentInfoP15mfxAdaptersInfo" title="MFXQueryAdapters"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">MFXQueryAdapters()</span></code></a> description for adapter priority rules.</p>
</div>
<div class="section" id="work-with-video-memory">
<h3>Work with Video Memory<a class="headerlink" href="#work-with-video-memory" title="Permalink to this headline">¶</a></h3>
<p>To fully utilize the oneVPL acceleration capability, the application should support
OS specific infrastructures. If using Microsoft* Windows*, the application
should support Microsoft DirectX*. If using Linux*, the application should
support the VA API for Linux.</p>
<p>The hardware acceleration support in an application consists of video memory
support and acceleration device support.</p>
<p>Depending on the usage model, the application can use video memory at different
stages in the pipeline. Three major scenarios are shown in the following
diagrams:</p>
<div class="graphviz"><img src="../../../../_images/graphviz-aaa036013d52c433dae6ffb9e95663c19fa1ea9f.png" alt="digraph {
  rankdir=LR;
  labelloc=&quot;t&quot;;
  label=&quot;oneVPL functions interconnection&quot;;
  F1 [shape=octagon label=&quot;oneVPL Function&quot;];
  F2 [shape=octagon label=&quot;oneVPL Function&quot;];
  F1-&gt;F2 [ label=&quot;Video Memory&quot; ];
}" class="graphviz" /></div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="graphviz"><img src="../../../../_images/graphviz-4c49c9a0025ac6d1a15e64ee523965878c6ce453.png" alt="digraph {
  rankdir=LR;
  labelloc=&quot;t&quot;;
  label=&quot;Video memory as output&quot;;
  F3 [shape=octagon label=&quot;oneVPL Function&quot;];
  F4 [shape=octagon label=&quot;Application&quot; fillcolor=lightgrey];
  F3-&gt;F4 [ label=&quot;Video Memory&quot; ];
}" class="graphviz" /></div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="graphviz"><img src="../../../../_images/graphviz-39e31570c6f96e0db07b1f492158588ad3e61a54.png" alt="digraph {
  rankdir=LR;
  labelloc=&quot;t&quot;;
  label=&quot;Video memory as input&quot;;
  F5 [shape=octagon label=&quot;Application&quot;];
  F6 [shape=octagon label=&quot;oneVPL Function&quot;];
  F5-&gt;F6 [ label=&quot;Video Memory&quot; ];
}" class="graphviz" /></div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>The application must use the <a class="reference internal" href="../API_ref/VPL_structs_cross_component.html#_CPPv4N13mfxVideoParam9IOPatternE" title="mfxVideoParam::IOPattern"><code class="xref cpp cpp-member docutils literal notranslate"><span class="pre">mfxVideoParam::IOPattern</span></code></a> field to
indicate the I/O access pattern during initialization. Subsequent function calls
must follow this access pattern. For example, if a function operates on video
memory surfaces at both input and output, the
application must specify the access pattern <cite>IOPattern</cite> at initialization in
<a class="reference internal" href="../API_ref/VPL_enums.html#_CPPv429MFX_IOPATTERN_IN_VIDEO_MEMORY" title="MFX_IOPATTERN_IN_VIDEO_MEMORY"><code class="xref cpp cpp-enumerator docutils literal notranslate"><span class="pre">MFX_IOPATTERN_IN_VIDEO_MEMORY</span></code></a> for input and
<a class="reference internal" href="../API_ref/VPL_enums.html#_CPPv430MFX_IOPATTERN_OUT_VIDEO_MEMORY" title="MFX_IOPATTERN_OUT_VIDEO_MEMORY"><code class="xref cpp cpp-enumerator docutils literal notranslate"><span class="pre">MFX_IOPATTERN_OUT_VIDEO_MEMORY</span></code></a> for output. This particular I/O
access pattern must not change inside the <strong>Init</strong> <strong>-</strong> <strong>Close</strong> sequence.</p>
<p>Initialization of any hardware accelerated oneVPL component requires the
acceleration device handle. This handle is also used by the oneVPL component to
query hardware capabilities. The application can share its device with oneVPL
by passing the device handle through the <a class="reference internal" href="../API_ref/VPL_func_vidcore.html#_CPPv422MFXVideoCORE_SetHandle10mfxSession13mfxHandleType6mfxHDL" title="MFXVideoCORE_SetHandle"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">MFXVideoCORE_SetHandle()</span></code></a>
function. It is recommended to share the handle before any actual usage of oneVPL.</p>
</div>
<div class="section" id="work-with-microsoft-directx-applications">
<span id="work-ms-directx-app"></span><h3>Work with Microsoft DirectX* Applications<a class="headerlink" href="#work-with-microsoft-directx-applications" title="Permalink to this headline">¶</a></h3>
<p>oneVPL supports two different infrastructures for hardware acceleration on the
Microsoft Windows OS: the Direct3D* 9 DXVA2 and Direct3D 11 Video API. If Direct3D 9
DXVA2 is used for hardware acceleration, the application should use the
<cite>IDirect3DDeviceManager9</cite> interface as the acceleration device handle. If the
Direct3D 11 Video API is used for hardware acceleration, the application should
use the <cite>ID3D11Device</cite> interface as the acceleration device handle.</p>
<p>The application should share one of these interfaces with oneVPL through the
<a class="reference internal" href="../API_ref/VPL_func_vidcore.html#_CPPv422MFXVideoCORE_SetHandle10mfxSession13mfxHandleType6mfxHDL" title="MFXVideoCORE_SetHandle"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">MFXVideoCORE_SetHandle()</span></code></a> function. If the application does not provide
the interface, then oneVPL creates its own internal acceleration device. As a result,
oneVPL input and output will be limited to system memory only for the external allocation mode, which will reduce oneVPL performance. If oneVPL fails to create a valid acceleration device,
then oneVPL cannot proceed with hardware acceleration and returns an error status to the
application.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It is recommended to work in the internal allocation mode if the application does not provide the <cite>IDirect3DDeviceManager9</cite> or <cite>ID3D11Device</cite> interface.</p>
</div>
<p>The application must create the Direct3D 9 device with the flag
<code class="docutils literal notranslate"><span class="pre">D3DCREATE_MULTITHREADED</span></code>. The flag <code class="docutils literal notranslate"><span class="pre">D3DCREATE_FPU_PRESERVE</span></code> is also
recommended. This influences floating-point calculations, including PTS values.</p>
<p>The application must also set multi-threading mode for the Direct3D 11 device.
The following example shows how to set multi-threading mode for a Direct3D 11
device:</p>
<div class="highlight-c++ notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">ID3D11Device</span>            <span class="o">*</span><span class="n">pD11Device</span><span class="p">;</span>
<span class="n">ID3D11DeviceContext</span>     <span class="o">*</span><span class="n">pD11Context</span><span class="p">;</span>
<span class="n">ID3D10Multithread</span>       <span class="o">*</span><span class="n">pD10Multithread</span><span class="p">;</span>

<span class="n">pD11Device</span><span class="o">-&gt;</span><span class="n">GetImmediateContext</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pD11Context</span><span class="p">);</span>
<span class="n">pD11Context</span><span class="o">-&gt;</span><span class="n">QueryInterface</span><span class="p">(</span><span class="n">IID_ID3D10Multithread</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pD10Multithread</span><span class="p">);</span>
<span class="n">pD10Multithread</span><span class="o">-&gt;</span><span class="n">SetMultithreadProtected</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
<p>During hardware acceleration, if a Direct3D “device lost” event occurs, the oneVPL
operation terminates with the <a class="reference internal" href="../API_ref/VPL_enums.html#_CPPv4N9mfxStatus19MFX_ERR_DEVICE_LOSTE" title="mfxStatus::MFX_ERR_DEVICE_LOST"><code class="xref cpp cpp-enumerator docutils literal notranslate"><span class="pre">mfxStatus::MFX_ERR_DEVICE_LOST</span></code></a>
return status. If the application provided the Direct3D device handle, the
application must reset the Direct3D device.</p>
<p>When the oneVPL decoder creates auxiliary devices for hardware acceleration, it
must allocate the list of Direct3D surfaces for I/O access, also known as the
surface chain, and pass the surface chain as part of the device creation command.
In most cases, the surface chain is the frame surface pool mentioned in the
<a class="reference internal" href="VPL_prg_frame.html#frame-surface-manag"><span class="std std-ref">Frame Surface Locking</span></a> section.</p>
<p>The application passes the surface chain to the oneVPL component <strong>Init</strong> function
through a oneVPL external allocator callback. See the
<a class="reference internal" href="VPL_prg_mem.html#mem-alloc-ext-alloc"><span class="std std-ref">Memory Allocation and External Allocators</span></a> section
for details.</p>
<p>Only the decoder <strong>Init</strong> function requests the external surface chain from the
application and uses it for auxiliary device creation. Encoder and VPP <strong>Init</strong>
functions may only request internal surfaces. See the
<a class="reference internal" href="../API_ref/VPL_enums.html#extmemframetype"><span class="std std-ref">ExtMemFrameType enumerator</span></a> for more details about
different memory types.</p>
<p>Depending on configuration parameters, oneVPL requires different surface types.
It is strongly recommended to call the <a class="reference internal" href="../API_ref/VPL_func_vid_encode.html#_CPPv426MFXVideoENCODE_QueryIOSurf10mfxSessionP13mfxVideoParamP20mfxFrameAllocRequest" title="MFXVideoENCODE_QueryIOSurf"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">MFXVideoENCODE_QueryIOSurf()</span></code></a>
function, the <a class="reference internal" href="../API_ref/VPL_func_vid_decode.html#_CPPv426MFXVideoDECODE_QueryIOSurf10mfxSessionP13mfxVideoParamP20mfxFrameAllocRequest" title="MFXVideoDECODE_QueryIOSurf"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">MFXVideoDECODE_QueryIOSurf()</span></code></a> function, or the
<a class="reference internal" href="../API_ref/VPL_func_vid_vpp.html#_CPPv423MFXVideoVPP_QueryIOSurf10mfxSessionP13mfxVideoParamAL2E_20mfxFrameAllocRequest" title="MFXVideoVPP_QueryIOSurf"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">MFXVideoVPP_QueryIOSurf()</span></code></a> function to determine the appropriate type in
the external allocation mode.</p>
</div>
<div class="section" id="work-with-va-api-applications">
<h3>Work with VA API Applications<a class="headerlink" href="#work-with-va-api-applications" title="Permalink to this headline">¶</a></h3>
<p>oneVPL supports the VA API infrastructure for hardware acceleration on Linux.
The application should use the <cite>VADisplay</cite> interface as the acceleration device
handle for this infrastructure and share it with oneVPL through the
<a class="reference internal" href="../API_ref/VPL_func_vidcore.html#_CPPv422MFXVideoCORE_SetHandle10mfxSession13mfxHandleType6mfxHDL" title="MFXVideoCORE_SetHandle"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">MFXVideoCORE_SetHandle()</span></code></a> function.</p>
<p>The following example shows how to obtain the VA display from the X Window System:</p>
<div class="highlight-default notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">Display</span>   <span class="o">*</span><span class="n">x11_display</span><span class="p">;</span>
<span class="n">VADisplay</span> <span class="n">va_display</span><span class="p">;</span>

<span class="n">x11_display</span> <span class="o">=</span> <span class="n">XOpenDisplay</span><span class="p">(</span><span class="n">current_display</span><span class="p">);</span>
<span class="n">va_display</span>  <span class="o">=</span> <span class="n">vaGetDisplay</span><span class="p">(</span><span class="n">x11_display</span><span class="p">);</span>

<span class="n">MFXVideoCORE_SetHandle</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">MFX_HANDLE_VA_DISPLAY</span><span class="p">,</span> <span class="p">(</span><span class="n">mfxHDL</span><span class="p">)</span> <span class="n">va_display</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
<p>The following example shows how to obtain the VA display from the Direct
Rendering Manager:</p>
<div class="highlight-default notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nb">int</span> <span class="n">card</span><span class="p">;</span>
<span class="n">VADisplay</span> <span class="n">va_display</span><span class="p">;</span>

<span class="n">card</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;/dev/dri/card0&quot;</span><span class="p">,</span> <span class="n">O_RDWR</span><span class="p">);</span> <span class="o">/*</span> <span class="n">primary</span> <span class="n">card</span> <span class="o">*/</span>
<span class="n">va_display</span> <span class="o">=</span> <span class="n">vaGetDisplayDRM</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
<span class="n">vaInitialize</span><span class="p">(</span><span class="n">va_display</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">major_version</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">minor_version</span><span class="p">);</span>

<span class="n">MFXVideoCORE_SetHandle</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">MFX_HANDLE_VA_DISPLAY</span><span class="p">,</span> <span class="p">(</span><span class="n">mfxHDL</span><span class="p">)</span> <span class="n">va_display</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
<p>When the oneVPL decoder creates a hardware acceleration device, it must allocate
the list of video memory surfaces for I/O access, also known as the surface chain,
and pass the surface chain as part of the device creation command. The
application passes the surface chain to the oneVPL component <strong>Init</strong> function
through a oneVPL external allocator callback.  See the
<a class="reference internal" href="VPL_prg_mem.html#mem-alloc-ext-alloc"><span class="std std-ref">Memory Allocation and External Allocators</span></a> section
for details.
Starting from oneVPL API version 2.0, oneVPL creates its own surface chain if an
external allocator is not set. See the :ref`New Model to work with Hardware Acceleration &lt;hw-acceleration&gt;`
section for details.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The VA API does not define any surface types and the application can
use either <a class="reference internal" href="../API_ref/VPL_enums.html#_CPPv439MFX_MEMTYPE_VIDEO_MEMORY_DECODER_TARGET" title="MFX_MEMTYPE_VIDEO_MEMORY_DECODER_TARGET"><code class="xref cpp cpp-enumerator docutils literal notranslate"><span class="pre">MFX_MEMTYPE_VIDEO_MEMORY_DECODER_TARGET</span></code></a>
or <a class="reference internal" href="../API_ref/VPL_enums.html#_CPPv441MFX_MEMTYPE_VIDEO_MEMORY_PROCESSOR_TARGET" title="MFX_MEMTYPE_VIDEO_MEMORY_PROCESSOR_TARGET"><code class="xref cpp cpp-enumerator docutils literal notranslate"><span class="pre">MFX_MEMTYPE_VIDEO_MEMORY_PROCESSOR_TARGET</span></code></a> to indicate data in video
memory.</p>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="VPL_prg_mem.html" class="btn btn-neutral float-right" title="Memory Allocation and External Allocators" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="VPL_prg_transcoding.html" class="btn btn-neutral float-left" title="Transcoding Procedures" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, Intel Corporation

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>
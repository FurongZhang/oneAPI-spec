<!--
SPDX-FileCopyrightText: 2019-2020 Intel Corporation

SPDX-License-Identifier: MIT
-->



<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Encoding Procedures &mdash; oneAPI Specification 1.0-rev-2 documentation</title>
  

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../../../_static/favicons.png"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/doctools.js"></script>
        <script src="../../../../_static/language_data.js"></script>
        <script src="../../../../_static/custom.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link rel="next" title="Video Processing Procedures" href="VPL_prg_vpp.html" />
    <link rel="prev" title="Decoding Procedures" href="VPL_prg_decoding.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="https://oneapi.com" class="icon icon-home"> oneAPI Specification
          

          
            
            <img src="../../../../_static/oneAPI-rgb-rev-100.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                1.0-rev-2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../architecture.html">Software Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dpcpp/source/index.html">DPC++</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../oneDPL/source/index.html">oneDPL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../oneDNN/source/index.html">oneDNN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../oneCCL/source/index.html">oneCCL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../l0/source/index.html">Level Zero</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../oneDAL/source/index.html">oneDAL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../oneTBB/source/nested-index.html">oneTBB</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">oneVPL</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../architecture/index.html">Architecture</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Programming Guide</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="VPL_prg_stc.html">Status Codes</a></li>
<li class="toctree-l3"><a class="reference internal" href="VPL_prg_session.html">oneVPL Session</a></li>
<li class="toctree-l3"><a class="reference internal" href="VPL_prg_frame.html">Frame and Fields</a></li>
<li class="toctree-l3"><a class="reference internal" href="VPL_prg_decoding.html">Decoding Procedures</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Encoding Procedures</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#external-memory">External Memory</a></li>
<li class="toctree-l4"><a class="reference internal" href="#internal-memory">Internal Memory</a></li>
<li class="toctree-l4"><a class="reference internal" href="#configuration-change">Configuration Change</a></li>
<li class="toctree-l4"><a class="reference internal" href="#external-bitrate-control">External Bitrate Control</a></li>
<li class="toctree-l4"><a class="reference internal" href="#jpeg">JPEG</a></li>
<li class="toctree-l4"><a class="reference internal" href="#multi-view-video-encoding">Multi-view Video Encoding</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="VPL_prg_vpp.html">Video Processing Procedures</a></li>
<li class="toctree-l3"><a class="reference internal" href="VPL_prg_transcoding.html">Transcoding Procedures</a></li>
<li class="toctree-l3"><a class="reference internal" href="VPL_prg_hw.html">Hardware Acceleration</a></li>
<li class="toctree-l3"><a class="reference internal" href="VPL_prg_mem.html">Memory Allocation and External Allocators</a></li>
<li class="toctree-l3"><a class="reference internal" href="VPL_prg_err.html">Hardware Device Error Handling</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../VPL_summary.html">Mandatory APIs and Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../API_ref/VPL_api_ref.html">oneVPL API Reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Versioning.html">oneVPL API Versioning</a></li>
<li class="toctree-l2"><a class="reference internal" href="../appendix/index.html">Appendices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../VPL_acronyms.html">Glossary</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../oneMKL/source/index.html">oneMKL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../versions.html">HTML and PDF Versions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notices.html">Legal Notices and Disclaimers</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">oneAPI Specification</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          <!--
SPDX-FileCopyrightText: 2019-2020 Intel Corporation

SPDX-License-Identifier: MIT
-->

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html">oneAPI Specification</a> &raquo;</li>
        
          
          <li><a href="../index.html">oneVPL</a> </li>
          
        
          
        
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            
              <a href="https://github.com/oneapi-src/oneapi-spec/blob/master/source/elements/oneVPL/source/programming_guide/VPL_prg_encoding.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="encoding-procedures">
<h1>Encoding Procedures<a class="headerlink" href="#encoding-procedures" title="Permalink to this headline">¶</a></h1>
<p>There are two methods for shared memory allocation and handling in oneVPL:
external and internal.</p>
<div class="section" id="external-memory">
<h2>External Memory<a class="headerlink" href="#external-memory" title="Permalink to this headline">¶</a></h2>
<p>The following pseudo code shows the encoding procedure with external memory
(legacy mode):</p>
<div class="highlight-c++ notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">MFXVideoENCODE_QueryIOSurf</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">init_param</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">request</span><span class="p">);</span>
<span class="n">allocate_pool_of_frame_surfaces</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">NumFrameSuggested</span><span class="p">);</span>
<span class="n">MFXVideoENCODE_Init</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">init_param</span><span class="p">);</span>
<span class="n">sts</span><span class="o">=</span><span class="n">MFX_ERR_MORE_DATA</span><span class="p">;</span>
<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">sts</span><span class="o">==</span><span class="n">MFX_ERR_MORE_DATA</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">end_of_stream</span><span class="p">())</span> <span class="p">{</span>
      <span class="n">find_unlocked_surface_from_the_pool</span><span class="p">(</span><span class="o">&amp;</span><span class="n">surface</span><span class="p">);</span>
      <span class="n">fill_content_for_encoding</span><span class="p">(</span><span class="n">surface</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="n">surface2</span><span class="o">=</span><span class="n">end_of_stream</span><span class="p">()</span><span class="o">?</span><span class="nb">NULL</span><span class="o">:</span><span class="n">surface</span><span class="p">;</span>
   <span class="n">sts</span><span class="o">=</span><span class="n">MFXVideoENCODE_EncodeFrameAsync</span><span class="p">(</span><span class="n">session</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="n">surface2</span><span class="p">,</span><span class="n">bits</span><span class="p">,</span><span class="o">&amp;</span><span class="n">syncp</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">end_of_stream</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">sts</span><span class="o">==</span><span class="n">MFX_ERR_MORE_DATA</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
   <span class="c1">// Skipped other error handling</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">sts</span><span class="o">==</span><span class="n">MFX_ERR_NONE</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">MFXVideoCORE_SyncOperation</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">syncp</span><span class="p">,</span> <span class="n">INFINITE</span><span class="p">);</span>
      <span class="n">do_something_with_encoded_bits</span><span class="p">(</span><span class="n">bits</span><span class="p">);</span>
   <span class="p">}</span>
<span class="p">}</span>
<span class="n">MFXVideoENCODE_Close</span><span class="p">(</span><span class="n">session</span><span class="p">);</span>
<span class="n">free_pool_of_frame_surfaces</span><span class="p">();</span>
</pre></div>
</td></tr></table></div>
<p>Note the following key points about the example:</p>
<ul class="simple">
<li><p>The application uses the <a class="reference internal" href="../API_ref/VPL_func_vid_encode.html#_CPPv426MFXVideoENCODE_QueryIOSurf10mfxSessionP13mfxVideoParamP20mfxFrameAllocRequest" title="MFXVideoENCODE_QueryIOSurf"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">MFXVideoENCODE_QueryIOSurf()</span></code></a> function to
obtain the number of working frame surfaces required for reordering input
frames.</p></li>
<li><p>The application calls the <a class="reference internal" href="../API_ref/VPL_func_vid_encode.html#_CPPv431MFXVideoENCODE_EncodeFrameAsync10mfxSessionP13mfxEncodeCtrlP16mfxFrameSurface1P12mfxBitstreamP12mfxSyncPoint" title="MFXVideoENCODE_EncodeFrameAsync"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">MFXVideoENCODE_EncodeFrameAsync()</span></code></a> function
for the encoding operation. The input frame must be in an unlocked frame
surface from the frame surface pool. If the encoding output is not available,
the function returns the <a class="reference internal" href="../API_ref/VPL_enums.html#_CPPv4N9mfxStatus17MFX_ERR_MORE_DATAE" title="mfxStatus::MFX_ERR_MORE_DATA"><code class="xref cpp cpp-enumerator docutils literal notranslate"><span class="pre">mfxStatus::MFX_ERR_MORE_DATA</span></code></a> status code
to request additional input frames.</p></li>
<li><p>Upon successful encoding, the <a class="reference internal" href="../API_ref/VPL_func_vid_encode.html#_CPPv431MFXVideoENCODE_EncodeFrameAsync10mfxSessionP13mfxEncodeCtrlP16mfxFrameSurface1P12mfxBitstreamP12mfxSyncPoint" title="MFXVideoENCODE_EncodeFrameAsync"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">MFXVideoENCODE_EncodeFrameAsync()</span></code></a>
function returns <a class="reference internal" href="../API_ref/VPL_enums.html#_CPPv4N9mfxStatus12MFX_ERR_NONEE" title="mfxStatus::MFX_ERR_NONE"><code class="xref cpp cpp-enumerator docutils literal notranslate"><span class="pre">mfxStatus::MFX_ERR_NONE</span></code></a>. At this point, the
encoded bitstream is not yet available because the
<a class="reference internal" href="../API_ref/VPL_func_vid_encode.html#_CPPv431MFXVideoENCODE_EncodeFrameAsync10mfxSessionP13mfxEncodeCtrlP16mfxFrameSurface1P12mfxBitstreamP12mfxSyncPoint" title="MFXVideoENCODE_EncodeFrameAsync"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">MFXVideoENCODE_EncodeFrameAsync()</span></code></a> function is asynchronous. The
application must use the <a class="reference internal" href="../API_ref/VPL_func_vidcore.html#_CPPv426MFXVideoCORE_SyncOperation10mfxSession12mfxSyncPoint6mfxU32" title="MFXVideoCORE_SyncOperation"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">MFXVideoCORE_SyncOperation()</span></code></a> function to
synchronize the encoding operation before retrieving the encoded bitstream.</p></li>
<li><p>At the end of the stream, the application continuously calls the
<a class="reference internal" href="../API_ref/VPL_func_vid_encode.html#_CPPv431MFXVideoENCODE_EncodeFrameAsync10mfxSessionP13mfxEncodeCtrlP16mfxFrameSurface1P12mfxBitstreamP12mfxSyncPoint" title="MFXVideoENCODE_EncodeFrameAsync"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">MFXVideoENCODE_EncodeFrameAsync()</span></code></a> function with a NULL surface
pointer to drain any remaining bitstreams cached within the oneVPL encoder,
until the function returns <a class="reference internal" href="../API_ref/VPL_enums.html#_CPPv4N9mfxStatus17MFX_ERR_MORE_DATAE" title="mfxStatus::MFX_ERR_MORE_DATA"><code class="xref cpp cpp-enumerator docutils literal notranslate"><span class="pre">mfxStatus::MFX_ERR_MORE_DATA</span></code></a>.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It is the application’s responsibility to fill pixels outside of the
crop window when it is smaller than the frame to be encoded, especially
in cases when crops are not aligned to minimum coding block size (16
for AVC and 8 for HEVC and VP9).</p>
</div>
</div>
<div class="section" id="internal-memory">
<h2>Internal Memory<a class="headerlink" href="#internal-memory" title="Permalink to this headline">¶</a></h2>
<p>The following pseudo code shows the encoding procedure with internal memory:</p>
<div class="highlight-c++ notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">MFXVideoENCODE_Init</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">init_param</span><span class="p">);</span>
<span class="n">sts</span><span class="o">=</span><span class="n">MFX_ERR_MORE_DATA</span><span class="p">;</span>
<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">sts</span><span class="o">==</span><span class="n">MFX_ERR_MORE_DATA</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">end_of_stream</span><span class="p">())</span> <span class="p">{</span>
      <span class="n">MFXMemory_GetSurfaceForEncode</span><span class="p">(</span><span class="n">session</span><span class="p">,</span><span class="o">&amp;</span><span class="n">surface</span><span class="p">);</span>
      <span class="n">fill_content_for_encoding</span><span class="p">(</span><span class="n">surface</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="n">surface2</span><span class="o">=</span><span class="n">end_of_stream</span><span class="p">()</span><span class="o">?</span><span class="nb">NULL</span><span class="o">:</span><span class="n">surface</span><span class="p">;</span>
   <span class="n">sts</span><span class="o">=</span><span class="n">MFXVideoENCODE_EncodeFrameAsync</span><span class="p">(</span><span class="n">session</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="n">surface2</span><span class="p">,</span><span class="n">bits</span><span class="p">,</span><span class="o">&amp;</span><span class="n">syncp</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">surface2</span><span class="p">)</span> <span class="n">surface</span><span class="o">-&gt;</span><span class="n">FrameInterface</span><span class="o">-&gt;</span><span class="n">Release</span><span class="p">(</span><span class="n">surface2</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">end_of_stream</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">sts</span><span class="o">==</span><span class="n">MFX_ERR_MORE_DATA</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
   <span class="c1">// Skipped other error handling</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">sts</span><span class="o">==</span><span class="n">MFX_ERR_NONE</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">MFXVideoCORE_SyncOperation</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">syncp</span><span class="p">,</span> <span class="n">INFINITE</span><span class="p">);</span>
      <span class="n">do_something_with_encoded_bits</span><span class="p">(</span><span class="n">bits</span><span class="p">);</span>
   <span class="p">}</span>
<span class="p">}</span>
<span class="n">MFXVideoENCODE_Close</span><span class="p">(</span><span class="n">session</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
<p>There are several key differences in this example, compared to external memory
(legacy mode):</p>
<ul class="simple">
<li><p>The application does not need to call the <a class="reference internal" href="../API_ref/VPL_func_vid_encode.html#_CPPv426MFXVideoENCODE_QueryIOSurf10mfxSessionP13mfxVideoParamP20mfxFrameAllocRequest" title="MFXVideoENCODE_QueryIOSurf"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">MFXVideoENCODE_QueryIOSurf()</span></code></a>
function to obtain the number of working frame surfaces since allocation is
done by oneVPL.</p></li>
<li><p>The application calls the <a class="reference internal" href="../API_ref/VPL_func_mem.html#_CPPv429MFXMemory_GetSurfaceForEncode10mfxSessionPP16mfxFrameSurface1" title="MFXMemory_GetSurfaceForEncode"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">MFXMemory_GetSurfaceForEncode()</span></code></a> function
to get a free surface for the subsequent encode operation.</p></li>
<li><p>The application must call the
<a class="reference internal" href="../API_ref/VPL_structs_memory.html#_CPPv4N24mfxFrameSurfaceInterface7ReleaseE" title="mfxFrameSurfaceInterface::Release"><code class="xref cpp cpp-member docutils literal notranslate"><span class="pre">mfxFrameSurfaceInterface::Release</span></code></a>
function to decrement the reference counter of the obtained surface after
the call to the <a class="reference internal" href="../API_ref/VPL_func_vid_encode.html#_CPPv431MFXVideoENCODE_EncodeFrameAsync10mfxSessionP13mfxEncodeCtrlP16mfxFrameSurface1P12mfxBitstreamP12mfxSyncPoint" title="MFXVideoENCODE_EncodeFrameAsync"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">MFXVideoENCODE_EncodeFrameAsync()</span></code></a> function.</p></li>
</ul>
</div>
<div class="section" id="configuration-change">
<span id="config-change"></span><h2>Configuration Change<a class="headerlink" href="#configuration-change" title="Permalink to this headline">¶</a></h2>
<p>The application changes configuration during encoding by calling the
<a class="reference internal" href="../API_ref/VPL_func_vid_encode.html#_CPPv420MFXVideoENCODE_Reset10mfxSessionP13mfxVideoParam" title="MFXVideoENCODE_Reset"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">MFXVideoENCODE_Reset()</span></code></a> function. Depending on the difference in
configuration parameters before and after the change, the oneVPL encoder will
either continue the current sequence or start a new one. If the encoder starts a
new sequence, it completely resets internal state and begins a new sequence with
the IDR frame.</p>
<p>The application controls encoder behavior during parameter change by attaching
the <a class="reference internal" href="../API_ref/VPL_structs_encode.html#_CPPv424mfxExtEncoderResetOption" title="mfxExtEncoderResetOption"><code class="xref cpp cpp-struct docutils literal notranslate"><span class="pre">mfxExtEncoderResetOption</span></code></a> structure to the <a class="reference internal" href="../API_ref/VPL_structs_cross_component.html#_CPPv413mfxVideoParam" title="mfxVideoParam"><code class="xref cpp cpp-struct docutils literal notranslate"><span class="pre">mfxVideoParam</span></code></a>
structure during reset. By using this structure, the application instructs the
encoder to start or not start a new sequence after reset. In some cases, the
request to continue the current sequence cannot be satisfied and the encoder will
fail during reset. To avoid this scenario, the application may query the reset
outcome before the actual reset by calling the <a class="reference internal" href="../API_ref/VPL_func_vid_encode.html#_CPPv420MFXVideoENCODE_Query10mfxSessionP13mfxVideoParamP13mfxVideoParam" title="MFXVideoENCODE_Query"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">MFXVideoENCODE_Query()</span></code></a> function
with the <a class="reference internal" href="../API_ref/VPL_structs_encode.html#_CPPv424mfxExtEncoderResetOption" title="mfxExtEncoderResetOption"><code class="xref cpp cpp-struct docutils literal notranslate"><span class="pre">mfxExtEncoderResetOption</span></code></a> attached to the
<a class="reference internal" href="../API_ref/VPL_structs_cross_component.html#_CPPv413mfxVideoParam" title="mfxVideoParam"><code class="xref cpp cpp-struct docutils literal notranslate"><span class="pre">mfxVideoParam</span></code></a> structure.</p>
<p>The application uses the following procedure to change encoding configurations:</p>
<ol class="arabic simple">
<li><p>The application retrieves any cached frames in the oneVPL encoder by calling the
<a class="reference internal" href="../API_ref/VPL_func_vid_encode.html#_CPPv431MFXVideoENCODE_EncodeFrameAsync10mfxSessionP13mfxEncodeCtrlP16mfxFrameSurface1P12mfxBitstreamP12mfxSyncPoint" title="MFXVideoENCODE_EncodeFrameAsync"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">MFXVideoENCODE_EncodeFrameAsync()</span></code></a> function with a NULL input frame
pointer until the function returns <a class="reference internal" href="../API_ref/VPL_enums.html#_CPPv4N9mfxStatus17MFX_ERR_MORE_DATAE" title="mfxStatus::MFX_ERR_MORE_DATA"><code class="xref cpp cpp-enumerator docutils literal notranslate"><span class="pre">mfxStatus::MFX_ERR_MORE_DATA</span></code></a>.</p></li>
<li><p>The application calls the <a class="reference internal" href="../API_ref/VPL_func_vid_encode.html#_CPPv420MFXVideoENCODE_Reset10mfxSessionP13mfxVideoParam" title="MFXVideoENCODE_Reset"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">MFXVideoENCODE_Reset()</span></code></a> function with the
new configuration:</p>
<ul class="simple">
<li><p>If the function successfully sets the configuration, the application can
continue encoding as usual.</p></li>
<li><p>If the new configuration requires a new memory allocation, the function
returns <a class="reference internal" href="../API_ref/VPL_enums.html#_CPPv4N9mfxStatus32MFX_ERR_INCOMPATIBLE_VIDEO_PARAME" title="mfxStatus::MFX_ERR_INCOMPATIBLE_VIDEO_PARAM"><code class="xref cpp cpp-enumerator docutils literal notranslate"><span class="pre">mfxStatus::MFX_ERR_INCOMPATIBLE_VIDEO_PARAM</span></code></a>. The
application must close the oneVPL encoder and reinitialize the encoding
procedure with the new configuration.</p></li>
</ul>
</li>
</ol>
</div>
<div class="section" id="external-bitrate-control">
<h2>External Bitrate Control<a class="headerlink" href="#external-bitrate-control" title="Permalink to this headline">¶</a></h2>
<p>The application can make the encoder use the external Bitrate Control (BRC)
instead of the native bitrate control. To make the encoder use the external BRC,
the application should attach the <a class="reference internal" href="../API_ref/VPL_structs_encode.html#_CPPv419mfxExtCodingOption2" title="mfxExtCodingOption2"><code class="xref cpp cpp-struct docutils literal notranslate"><span class="pre">mfxExtCodingOption2</span></code></a> structure with
<code class="docutils literal notranslate"><span class="pre">ExtBRC</span> <span class="pre">=</span> <span class="pre">MFX_CODINGOPTION_ON</span></code> and the <a class="reference internal" href="../API_ref/VPL_structs_encode.html#_CPPv49mfxExtBRC" title="mfxExtBRC"><code class="xref cpp cpp-struct docutils literal notranslate"><span class="pre">mfxExtBRC</span></code></a> callback structure
to the <a class="reference internal" href="../API_ref/VPL_structs_cross_component.html#_CPPv413mfxVideoParam" title="mfxVideoParam"><code class="xref cpp cpp-struct docutils literal notranslate"><span class="pre">mfxVideoParam</span></code></a> structure during encoder initialization.
The <strong>Init</strong>, <strong>Reset</strong>, and <strong>Close</strong> callbacks will be invoked inside their
corresponding functions: <a class="reference internal" href="../API_ref/VPL_func_vid_encode.html#_CPPv419MFXVideoENCODE_Init10mfxSessionP13mfxVideoParam" title="MFXVideoENCODE_Init"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">MFXVideoENCODE_Init()</span></code></a>,
<a class="reference internal" href="../API_ref/VPL_func_vid_encode.html#_CPPv420MFXVideoENCODE_Reset10mfxSessionP13mfxVideoParam" title="MFXVideoENCODE_Reset"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">MFXVideoENCODE_Reset()</span></code></a>, and <a class="reference internal" href="../API_ref/VPL_func_vid_encode.html#_CPPv420MFXVideoENCODE_Close10mfxSession" title="MFXVideoENCODE_Close"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">MFXVideoENCODE_Close()</span></code></a>. The
following figure shows asynchronous encoding flow with external BRC (using
<code class="docutils literal notranslate"><span class="pre">GetFrameCtrl</span></code> and <code class="docutils literal notranslate"><span class="pre">Update</span></code>):</p>
<div class="figure align-default" id="id1">
<img alt="Asynchronous encoding flow with external BRC" src="../../../../_images/extbrc_async.png" />
<p class="caption"><span class="caption-text">Asynchronous encoding flow with external BRC</span><a class="headerlink" href="#id1" title="Permalink to this image">¶</a></p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code class="docutils literal notranslate"><span class="pre">IntAsyncDepth</span></code> is the oneVPL max internal asynchronous encoding queue
size. It is always less than or equal to <a class="reference internal" href="../API_ref/VPL_structs_cross_component.html#_CPPv4N13mfxVideoParam10AsyncDepthE" title="mfxVideoParam::AsyncDepth"><code class="xref cpp cpp-member docutils literal notranslate"><span class="pre">mfxVideoParam::AsyncDepth</span></code></a>.</p>
</div>
<p>The following pseudo code shows use of the external BRC:</p>
<div class="highlight-c++ notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289</pre></div></td><td class="code"><div class="highlight"><pre><span></span>   <span class="cp">#include</span> <span class="cpf">&quot;mfxvideo.h&quot;</span><span class="cp"></span>
   <span class="cp">#include</span> <span class="cpf">&quot;mfxbrc.h&quot;</span><span class="cp"></span>

   <span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
      <span class="n">mfxU32</span> <span class="n">EncodedOrder</span><span class="p">;</span>
      <span class="n">mfxI32</span> <span class="n">QP</span><span class="p">;</span>
      <span class="n">mfxU32</span> <span class="n">MaxSize</span><span class="p">;</span>
      <span class="n">mfxU32</span> <span class="n">MinSize</span><span class="p">;</span>
      <span class="n">mfxU16</span> <span class="n">Status</span><span class="p">;</span>
      <span class="n">mfxU64</span> <span class="n">StartTime</span><span class="p">;</span>
      <span class="c1">// ... skipped</span>
   <span class="p">}</span> <span class="n">MyBrcFrame</span><span class="p">;</span>

   <span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
      <span class="n">MyBrcFrame</span><span class="o">*</span> <span class="n">frame_queue</span><span class="p">;</span>
      <span class="n">mfxU32</span> <span class="n">frame_queue_size</span><span class="p">;</span>
      <span class="n">mfxU32</span> <span class="n">frame_queue_max_size</span><span class="p">;</span>
      <span class="n">mfxI32</span> <span class="n">max_qp</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span> <span class="c1">//I,P,B</span>
      <span class="n">mfxI32</span> <span class="n">min_qp</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span> <span class="c1">//I,P,B</span>
      <span class="c1">// ... skipped</span>
   <span class="p">}</span> <span class="n">MyBrcContext</span><span class="p">;</span>

   <span class="kt">void</span><span class="o">*</span> <span class="nf">GetExtBuffer</span><span class="p">(</span><span class="n">mfxExtBuffer</span><span class="o">**</span> <span class="n">ExtParam</span><span class="p">,</span> <span class="n">mfxU16</span> <span class="n">NumExtParam</span><span class="p">,</span> <span class="n">mfxU32</span> <span class="n">bufferID</span><span class="p">)</span>
   <span class="p">{</span>
       <span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
       <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NumExtParam</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
           <span class="k">if</span><span class="p">(</span><span class="n">ExtParam</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">BufferId</span> <span class="o">==</span> <span class="n">bufferID</span><span class="p">)</span> <span class="k">return</span> <span class="n">ExtParam</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
       <span class="p">}</span>
       <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="k">static</span> <span class="kt">int</span> <span class="n">IsParametersSupported</span><span class="p">(</span><span class="n">mfxVideoParam</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
   <span class="p">{</span>
       <span class="c1">// do some checks</span>
       <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="k">static</span> <span class="kt">int</span> <span class="n">IsResetPossible</span><span class="p">(</span><span class="n">MyBrcContext</span><span class="o">*</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">mfxVideoParam</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
   <span class="p">{</span>
       <span class="c1">// do some checks</span>
       <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="k">static</span> <span class="n">MyBrcFrame</span><span class="o">*</span> <span class="n">GetFrame</span><span class="p">(</span><span class="n">MyBrcFrame</span> <span class="o">*</span><span class="n">frame_queue</span><span class="p">,</span> <span class="n">mfxU32</span> <span class="n">frame_queue_size</span><span class="p">,</span> <span class="n">mfxU32</span> <span class="n">EncodedOrder</span><span class="p">)</span>
   <span class="p">{</span>
       <span class="c1">//do some logic</span>
       <span class="k">if</span><span class="p">(</span><span class="n">frame_queue_size</span><span class="p">)</span> <span class="k">return</span> <span class="o">&amp;</span><span class="n">frame_queue</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
       <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="k">static</span> <span class="n">mfxU32</span> <span class="n">GetFrameCost</span><span class="p">(</span><span class="n">mfxU16</span> <span class="n">FrameType</span><span class="p">,</span> <span class="n">mfxU16</span> <span class="n">PyramidLayer</span><span class="p">)</span>
   <span class="p">{</span>
       <span class="c1">// calculate cost</span>
       <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="k">static</span> <span class="n">mfxU32</span> <span class="n">GetMinSize</span><span class="p">(</span><span class="n">MyBrcContext</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="n">mfxU32</span> <span class="n">cost</span><span class="p">)</span>
   <span class="p">{</span>
       <span class="c1">// do some logic</span>
       <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="k">static</span> <span class="n">mfxU32</span> <span class="n">GetMaxSize</span><span class="p">(</span><span class="n">MyBrcContext</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="n">mfxU32</span> <span class="n">cost</span><span class="p">)</span>
   <span class="p">{</span>
       <span class="c1">// do some logic</span>
       <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="k">static</span> <span class="n">mfxI32</span> <span class="n">GetInitQP</span><span class="p">(</span><span class="n">MyBrcContext</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="n">mfxU32</span> <span class="n">MinSize</span><span class="p">,</span> <span class="n">mfxU32</span> <span class="n">MaxSize</span><span class="p">,</span> <span class="n">mfxU32</span> <span class="n">cost</span><span class="p">)</span>
   <span class="p">{</span>
       <span class="c1">// do some logic</span>
       <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="k">static</span> <span class="n">mfxU64</span> <span class="n">GetTime</span><span class="p">()</span>
   <span class="p">{</span>
       <span class="n">mfxU64</span> <span class="n">wallClock</span><span class="p">;</span>
       <span class="k">return</span> <span class="n">wallClock</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="k">static</span> <span class="kt">void</span> <span class="n">UpdateBRCState</span><span class="p">(</span><span class="n">mfxU32</span> <span class="n">CodedFrameSize</span><span class="p">,</span> <span class="n">MyBrcContext</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
   <span class="p">{</span>
       <span class="k">return</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="k">static</span> <span class="kt">void</span> <span class="n">RemoveFromQueue</span><span class="p">(</span><span class="n">MyBrcFrame</span><span class="o">*</span> <span class="n">frame_queue</span><span class="p">,</span> <span class="n">mfxU32</span> <span class="n">frame_queue_size</span><span class="p">,</span> <span class="n">MyBrcFrame</span><span class="o">*</span> <span class="n">frame</span><span class="p">)</span>
   <span class="p">{</span>
       <span class="k">return</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="k">static</span> <span class="n">mfxU64</span> <span class="n">GetMaxFrameEncodingTime</span><span class="p">(</span><span class="n">MyBrcContext</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
   <span class="p">{</span>
       <span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="n">mfxStatus</span> <span class="n">MyBrcInit</span><span class="p">(</span><span class="n">mfxHDL</span> <span class="n">pthis</span><span class="p">,</span> <span class="n">mfxVideoParam</span><span class="o">*</span> <span class="n">par</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">MyBrcContext</span><span class="o">*</span> <span class="n">ctx</span> <span class="o">=</span> <span class="p">(</span><span class="n">MyBrcContext</span><span class="o">*</span><span class="p">)</span><span class="n">pthis</span><span class="p">;</span>
      <span class="n">mfxI32</span> <span class="n">QpBdOffset</span><span class="p">;</span>
      <span class="n">mfxExtCodingOption2</span><span class="o">*</span> <span class="n">co2</span><span class="p">;</span>
      <span class="n">mfxI32</span> <span class="n">defaultQP</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pthis</span> <span class="o">||</span> <span class="o">!</span><span class="n">par</span><span class="p">)</span>
         <span class="k">return</span> <span class="n">MFX_ERR_NULL_PTR</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IsParametersSupported</span><span class="p">(</span><span class="n">par</span><span class="p">))</span>
         <span class="k">return</span> <span class="n">MFX_ERR_UNSUPPORTED</span><span class="p">;</span>

      <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">frame_queue_max_size</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">AsyncDepth</span><span class="p">;</span>
      <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">frame_queue</span> <span class="o">=</span> <span class="p">(</span><span class="n">MyBrcFrame</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">MyBrcFrame</span><span class="p">)</span> <span class="o">*</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">frame_queue_max_size</span><span class="p">);</span>

      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">frame_queue</span><span class="p">)</span>
         <span class="k">return</span> <span class="n">MFX_ERR_MEMORY_ALLOC</span><span class="p">;</span>

      <span class="n">co2</span> <span class="o">=</span> <span class="p">(</span><span class="n">mfxExtCodingOption2</span><span class="o">*</span><span class="p">)</span><span class="n">GetExtBuffer</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">ExtParam</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">NumExtParam</span><span class="p">,</span> <span class="n">MFX_EXTBUFF_CODING_OPTION2</span><span class="p">);</span>
      <span class="n">QpBdOffset</span> <span class="o">=</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">mfx</span><span class="p">.</span><span class="n">FrameInfo</span><span class="p">.</span><span class="n">BitDepthLuma</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="mi">6</span> <span class="o">*</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">mfx</span><span class="p">.</span><span class="n">FrameInfo</span><span class="p">.</span><span class="n">BitDepthLuma</span> <span class="o">-</span> <span class="mi">8</span><span class="p">))</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

      <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">max_qp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">co2</span> <span class="o">&amp;&amp;</span> <span class="n">co2</span><span class="o">-&gt;</span><span class="n">MaxQPI</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">co2</span><span class="o">-&gt;</span><span class="n">MaxQPI</span> <span class="o">-</span> <span class="n">QpBdOffset</span><span class="p">)</span> <span class="o">:</span> <span class="n">defaultQP</span><span class="p">;</span>
      <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">min_qp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">co2</span> <span class="o">&amp;&amp;</span> <span class="n">co2</span><span class="o">-&gt;</span><span class="n">MinQPI</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">co2</span><span class="o">-&gt;</span><span class="n">MinQPI</span> <span class="o">-</span> <span class="n">QpBdOffset</span><span class="p">)</span> <span class="o">:</span> <span class="n">defaultQP</span><span class="p">;</span>

      <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">max_qp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">co2</span> <span class="o">&amp;&amp;</span> <span class="n">co2</span><span class="o">-&gt;</span><span class="n">MaxQPP</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">co2</span><span class="o">-&gt;</span><span class="n">MaxQPP</span> <span class="o">-</span> <span class="n">QpBdOffset</span><span class="p">)</span> <span class="o">:</span> <span class="n">defaultQP</span><span class="p">;</span>
      <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">min_qp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">co2</span> <span class="o">&amp;&amp;</span> <span class="n">co2</span><span class="o">-&gt;</span><span class="n">MinQPP</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">co2</span><span class="o">-&gt;</span><span class="n">MinQPP</span> <span class="o">-</span> <span class="n">QpBdOffset</span><span class="p">)</span> <span class="o">:</span> <span class="n">defaultQP</span><span class="p">;</span>

      <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">max_qp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">co2</span> <span class="o">&amp;&amp;</span> <span class="n">co2</span><span class="o">-&gt;</span><span class="n">MaxQPB</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">co2</span><span class="o">-&gt;</span><span class="n">MaxQPB</span> <span class="o">-</span> <span class="n">QpBdOffset</span><span class="p">)</span> <span class="o">:</span> <span class="n">defaultQP</span><span class="p">;</span>
      <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">min_qp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">co2</span> <span class="o">&amp;&amp;</span> <span class="n">co2</span><span class="o">-&gt;</span><span class="n">MinQPB</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">co2</span><span class="o">-&gt;</span><span class="n">MinQPB</span> <span class="o">-</span> <span class="n">QpBdOffset</span><span class="p">)</span> <span class="o">:</span> <span class="n">defaultQP</span><span class="p">;</span>

      <span class="c1">// skipped initialization of other other BRC parameters</span>

      <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">frame_queue_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

      <span class="k">return</span> <span class="n">MFX_ERR_NONE</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="n">mfxStatus</span> <span class="n">MyBrcReset</span><span class="p">(</span><span class="n">mfxHDL</span> <span class="n">pthis</span><span class="p">,</span> <span class="n">mfxVideoParam</span><span class="o">*</span> <span class="n">par</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">MyBrcContext</span><span class="o">*</span> <span class="n">ctx</span> <span class="o">=</span> <span class="p">(</span><span class="n">MyBrcContext</span><span class="o">*</span><span class="p">)</span><span class="n">pthis</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pthis</span> <span class="o">||</span> <span class="o">!</span><span class="n">par</span><span class="p">)</span>
         <span class="k">return</span> <span class="n">MFX_ERR_NULL_PTR</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IsParametersSupported</span><span class="p">(</span><span class="n">par</span><span class="p">))</span>
         <span class="k">return</span> <span class="n">MFX_ERR_UNSUPPORTED</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IsResetPossible</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">par</span><span class="p">))</span>
         <span class="k">return</span> <span class="n">MFX_ERR_INCOMPATIBLE_VIDEO_PARAM</span><span class="p">;</span>

      <span class="c1">// reset here BRC parameters if required</span>

      <span class="k">return</span> <span class="n">MFX_ERR_NONE</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="n">mfxStatus</span> <span class="n">MyBrcClose</span><span class="p">(</span><span class="n">mfxHDL</span> <span class="n">pthis</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">MyBrcContext</span><span class="o">*</span> <span class="n">ctx</span> <span class="o">=</span> <span class="p">(</span><span class="n">MyBrcContext</span><span class="o">*</span><span class="p">)</span><span class="n">pthis</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pthis</span><span class="p">)</span>
         <span class="k">return</span> <span class="n">MFX_ERR_NULL_PTR</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">frame_queue</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">free</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">frame_queue</span><span class="p">);</span>
         <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">frame_queue</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
         <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">frame_queue_max_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
         <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">frame_queue_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="k">return</span> <span class="n">MFX_ERR_NONE</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="n">mfxStatus</span> <span class="n">MyBrcGetFrameCtrl</span><span class="p">(</span><span class="n">mfxHDL</span> <span class="n">pthis</span><span class="p">,</span> <span class="n">mfxBRCFrameParam</span><span class="o">*</span> <span class="n">par</span><span class="p">,</span> <span class="n">mfxBRCFrameCtrl</span><span class="o">*</span> <span class="n">ctrl</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">MyBrcContext</span><span class="o">*</span> <span class="n">ctx</span> <span class="o">=</span> <span class="p">(</span><span class="n">MyBrcContext</span><span class="o">*</span><span class="p">)</span><span class="n">pthis</span><span class="p">;</span>
      <span class="n">MyBrcFrame</span><span class="o">*</span> <span class="n">frame</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
      <span class="n">mfxU32</span> <span class="n">cost</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pthis</span> <span class="o">||</span> <span class="o">!</span><span class="n">par</span> <span class="o">||</span> <span class="o">!</span><span class="n">ctrl</span><span class="p">)</span>
         <span class="k">return</span> <span class="n">MFX_ERR_NULL_PTR</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">NumRecode</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
         <span class="n">frame</span> <span class="o">=</span> <span class="n">GetFrame</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">frame_queue</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">frame_queue_size</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">EncodedOrder</span><span class="p">);</span>
      <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">frame_queue_size</span> <span class="o">&lt;</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">frame_queue_max_size</span><span class="p">)</span>
         <span class="n">frame</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">frame_queue</span><span class="p">[</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">frame_queue_size</span><span class="o">++</span><span class="p">];</span>

      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">frame</span><span class="p">)</span>
         <span class="k">return</span> <span class="n">MFX_ERR_UNDEFINED_BEHAVIOR</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">NumRecode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">frame</span><span class="o">-&gt;</span><span class="n">EncodedOrder</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">EncodedOrder</span><span class="p">;</span>
         <span class="n">cost</span> <span class="o">=</span> <span class="n">GetFrameCost</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">FrameType</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">PyramidLayer</span><span class="p">);</span>
         <span class="n">frame</span><span class="o">-&gt;</span><span class="n">MinSize</span> <span class="o">=</span> <span class="n">GetMinSize</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">cost</span><span class="p">);</span>
         <span class="n">frame</span><span class="o">-&gt;</span><span class="n">MaxSize</span> <span class="o">=</span> <span class="n">GetMaxSize</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">cost</span><span class="p">);</span>
         <span class="n">frame</span><span class="o">-&gt;</span><span class="n">QP</span> <span class="o">=</span> <span class="n">GetInitQP</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">MinSize</span><span class="p">,</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">MaxSize</span><span class="p">,</span> <span class="n">cost</span><span class="p">);</span> <span class="c1">// from QP/size stat</span>
         <span class="n">frame</span><span class="o">-&gt;</span><span class="n">StartTime</span> <span class="o">=</span> <span class="n">GetTime</span><span class="p">();</span>
      <span class="p">}</span>

      <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">QpY</span> <span class="o">=</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">QP</span><span class="p">;</span>

      <span class="k">return</span> <span class="n">MFX_ERR_NONE</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="cp">#define DEFAULT_QP_INC 4</span>
   <span class="cp">#define DEFAULT_QP_DEC 4</span>

   <span class="n">mfxStatus</span> <span class="n">MyBrcUpdate</span><span class="p">(</span><span class="n">mfxHDL</span> <span class="n">pthis</span><span class="p">,</span> <span class="n">mfxBRCFrameParam</span><span class="o">*</span> <span class="n">par</span><span class="p">,</span> <span class="n">mfxBRCFrameCtrl</span><span class="o">*</span> <span class="n">ctrl</span><span class="p">,</span> <span class="n">mfxBRCFrameStatus</span><span class="o">*</span> <span class="n">status</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">MyBrcContext</span><span class="o">*</span> <span class="n">ctx</span> <span class="o">=</span> <span class="p">(</span><span class="n">MyBrcContext</span><span class="o">*</span><span class="p">)</span><span class="n">pthis</span><span class="p">;</span>
      <span class="n">MyBrcFrame</span><span class="o">*</span> <span class="n">frame</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
      <span class="n">mfxU32</span> <span class="n">panic</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pthis</span> <span class="o">||</span> <span class="o">!</span><span class="n">par</span> <span class="o">||</span> <span class="o">!</span><span class="n">ctrl</span> <span class="o">||</span> <span class="o">!</span><span class="n">status</span><span class="p">)</span>
         <span class="k">return</span> <span class="n">MFX_ERR_NULL_PTR</span><span class="p">;</span>

      <span class="n">frame</span> <span class="o">=</span> <span class="n">GetFrame</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">frame_queue</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">frame_queue_size</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">EncodedOrder</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">frame</span><span class="p">)</span>
         <span class="k">return</span> <span class="n">MFX_ERR_UNDEFINED_BEHAVIOR</span><span class="p">;</span>

      <span class="c1">// update QP/size stat here</span>

      <span class="k">if</span> <span class="p">(</span>   <span class="n">frame</span><span class="o">-&gt;</span><span class="n">Status</span> <span class="o">==</span> <span class="n">MFX_BRC_PANIC_BIG_FRAME</span>
        <span class="o">||</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">Status</span> <span class="o">==</span> <span class="n">MFX_BRC_PANIC_SMALL_FRAME</span><span class="p">)</span>
         <span class="n">panic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">panic</span> <span class="o">||</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">CodedFrameSize</span> <span class="o">&gt;=</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">MinSize</span> <span class="o">&amp;&amp;</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">CodedFrameSize</span> <span class="o">&lt;=</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">MaxSize</span><span class="p">))</span> <span class="p">{</span>
         <span class="n">UpdateBRCState</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">CodedFrameSize</span><span class="p">,</span> <span class="n">ctx</span><span class="p">);</span>
         <span class="n">RemoveFromQueue</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">frame_queue</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">frame_queue_size</span><span class="p">,</span> <span class="n">frame</span><span class="p">);</span>
         <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">frame_queue_size</span><span class="o">--</span><span class="p">;</span>
         <span class="n">status</span><span class="o">-&gt;</span><span class="n">BRCStatus</span> <span class="o">=</span> <span class="n">MFX_BRC_OK</span><span class="p">;</span>

         <span class="c1">// Here update Min/MaxSize for all queued frames</span>

         <span class="k">return</span> <span class="n">MFX_ERR_NONE</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="n">panic</span> <span class="o">=</span> <span class="p">((</span><span class="n">GetTime</span><span class="p">()</span> <span class="o">-</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">StartTime</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">GetMaxFrameEncodingTime</span><span class="p">(</span><span class="n">ctx</span><span class="p">));</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">CodedFrameSize</span> <span class="o">&gt;</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">MaxSize</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">panic</span> <span class="o">||</span> <span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">QP</span> <span class="o">&gt;=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">max_qp</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="p">{</span>
            <span class="n">frame</span><span class="o">-&gt;</span><span class="n">Status</span> <span class="o">=</span> <span class="n">MFX_BRC_PANIC_BIG_FRAME</span><span class="p">;</span>
         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">frame</span><span class="o">-&gt;</span><span class="n">Status</span> <span class="o">=</span> <span class="n">MFX_BRC_BIG_FRAME</span><span class="p">;</span>
            <span class="n">frame</span><span class="o">-&gt;</span><span class="n">QP</span> <span class="o">=</span> <span class="n">DEFAULT_QP_INC</span><span class="p">;</span>
         <span class="p">}</span>
      <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">CodedFrameSize</span> <span class="o">&lt;</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">MinSize</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">panic</span> <span class="o">||</span> <span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">QP</span> <span class="o">&lt;=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">min_qp</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="p">{</span>
            <span class="n">frame</span><span class="o">-&gt;</span><span class="n">Status</span> <span class="o">=</span> <span class="n">MFX_BRC_PANIC_SMALL_FRAME</span><span class="p">;</span>
            <span class="n">status</span><span class="o">-&gt;</span><span class="n">MinFrameSize</span> <span class="o">=</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">MinSize</span><span class="p">;</span>
         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">frame</span><span class="o">-&gt;</span><span class="n">Status</span> <span class="o">=</span> <span class="n">MFX_BRC_SMALL_FRAME</span><span class="p">;</span>
            <span class="n">frame</span><span class="o">-&gt;</span><span class="n">QP</span> <span class="o">=</span> <span class="n">DEFAULT_QP_DEC</span><span class="p">;</span>
         <span class="p">}</span>
      <span class="p">}</span>

      <span class="n">status</span><span class="o">-&gt;</span><span class="n">BRCStatus</span> <span class="o">=</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">Status</span><span class="p">;</span>

      <span class="k">return</span> <span class="n">MFX_ERR_NONE</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="kt">void</span> <span class="n">EncoderInit</span><span class="p">()</span>
   <span class="p">{</span>
        <span class="c1">//initialize encoder</span>
        <span class="n">MyBrcContext</span> <span class="n">brc_ctx</span><span class="p">;</span>
        <span class="n">mfxExtBRC</span> <span class="n">ext_brc</span><span class="p">;</span>
        <span class="n">mfxExtCodingOption2</span> <span class="n">co2</span><span class="p">;</span>
        <span class="n">mfxExtBuffer</span><span class="o">*</span> <span class="n">ext_buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="o">&amp;</span><span class="n">co2</span><span class="p">.</span><span class="n">Header</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ext_brc</span><span class="p">.</span><span class="n">Header</span><span class="p">};</span>
        <span class="n">mfxVideoParam</span> <span class="n">vpar</span><span class="p">;</span>

        <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">brc_ctx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">MyBrcContext</span><span class="p">));</span>
        <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ext_brc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mfxExtBRC</span><span class="p">));</span>
        <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">co2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mfxExtCodingOption2</span><span class="p">));</span>

        <span class="n">vpar</span><span class="p">.</span><span class="n">ExtParam</span> <span class="o">=</span> <span class="n">ext_buf</span><span class="p">;</span>
        <span class="n">vpar</span><span class="p">.</span><span class="n">NumExtParam</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ext_buf</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ext_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

        <span class="n">co2</span><span class="p">.</span><span class="n">Header</span><span class="p">.</span><span class="n">BufferId</span> <span class="o">=</span> <span class="n">MFX_EXTBUFF_CODING_OPTION2</span><span class="p">;</span>
        <span class="n">co2</span><span class="p">.</span><span class="n">Header</span><span class="p">.</span><span class="n">BufferSz</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mfxExtCodingOption2</span><span class="p">);</span>
        <span class="n">co2</span><span class="p">.</span><span class="n">ExtBRC</span> <span class="o">=</span> <span class="n">MFX_CODINGOPTION_ON</span><span class="p">;</span>

        <span class="n">ext_brc</span><span class="p">.</span><span class="n">Header</span><span class="p">.</span><span class="n">BufferId</span> <span class="o">=</span> <span class="n">MFX_EXTBUFF_BRC</span><span class="p">;</span>
        <span class="n">ext_brc</span><span class="p">.</span><span class="n">Header</span><span class="p">.</span><span class="n">BufferSz</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mfxExtBRC</span><span class="p">);</span>
        <span class="n">ext_brc</span><span class="p">.</span><span class="n">pthis</span>           <span class="o">=</span> <span class="o">&amp;</span><span class="n">brc_ctx</span><span class="p">;</span>
        <span class="n">ext_brc</span><span class="p">.</span><span class="n">Init</span>            <span class="o">=</span> <span class="n">MyBrcInit</span><span class="p">;</span>
        <span class="n">ext_brc</span><span class="p">.</span><span class="n">Reset</span>           <span class="o">=</span> <span class="n">MyBrcReset</span><span class="p">;</span>
        <span class="n">ext_brc</span><span class="p">.</span><span class="n">Close</span>           <span class="o">=</span> <span class="n">MyBrcClose</span><span class="p">;</span>
        <span class="n">ext_brc</span><span class="p">.</span><span class="n">GetFrameCtrl</span>    <span class="o">=</span> <span class="n">MyBrcGetFrameCtrl</span><span class="p">;</span>
        <span class="n">ext_brc</span><span class="p">.</span><span class="n">Update</span>          <span class="o">=</span> <span class="n">MyBrcUpdate</span><span class="p">;</span>

        <span class="n">sts</span> <span class="o">=</span> <span class="n">MFXVideoENCODE_Query</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vpar</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vpar</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">sts</span> <span class="o">==</span> <span class="n">MFX_ERR_UNSUPPORTED</span> <span class="o">||</span> <span class="n">co2</span><span class="p">.</span><span class="n">ExtBRC</span> <span class="o">!=</span> <span class="n">MFX_CODINGOPTION_ON</span><span class="p">)</span>
            <span class="c1">// unsupported case</span>
            <span class="n">sts</span> <span class="o">=</span> <span class="n">sts</span><span class="p">;</span>
        <span class="k">else</span>
            <span class="n">sts</span> <span class="o">=</span> <span class="n">MFXVideoENCODE_Init</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vpar</span><span class="p">);</span>
   <span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="jpeg">
<h2>JPEG<a class="headerlink" href="#jpeg" title="Permalink to this headline">¶</a></h2>
<p>The application can use the same encoding procedures for JPEG/motion JPEG
encoding, as shown in the following pseudo code:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// encoder initialization</span>
<span class="n">MFXVideoENCODE_Init</span> <span class="p">(...);</span>
<span class="c1">// single frame/picture encoding</span>
<span class="n">MFXVideoENCODE_EncodeFrameAsync</span> <span class="p">(...);</span>
<span class="n">MFXVideoCORE_SyncOperation</span><span class="p">(...);</span>
<span class="c1">// close down</span>
<span class="n">MFXVideoENCODE_Close</span><span class="p">(...);</span>
</pre></div>
</div>
<p>The application may specify Huffman and quantization tables during encoder
initialization by attaching <a class="reference internal" href="../API_ref/VPL_structs_cross_component.html#_CPPv421mfxExtJPEGQuantTables" title="mfxExtJPEGQuantTables"><code class="xref cpp cpp-struct docutils literal notranslate"><span class="pre">mfxExtJPEGQuantTables</span></code></a> and
<a class="reference internal" href="../API_ref/VPL_structs_cross_component.html#_CPPv423mfxExtJPEGHuffmanTables" title="mfxExtJPEGHuffmanTables"><code class="xref cpp cpp-struct docutils literal notranslate"><span class="pre">mfxExtJPEGHuffmanTables</span></code></a> buffers to the <a class="reference internal" href="../API_ref/VPL_structs_cross_component.html#_CPPv413mfxVideoParam" title="mfxVideoParam"><code class="xref cpp cpp-struct docutils literal notranslate"><span class="pre">mfxVideoParam</span></code></a>
structure. If the application does not define tables, then the oneVPL encoder uses
tables recommended in ITU-T* Recommendation T.81. If the application does not
define a quantization table it must specify the <a class="reference internal" href="../API_ref/VPL_structs_cross_component.html#_CPPv4N10mfxInfoMFX7QualityE" title="mfxInfoMFX::Quality"><code class="xref cpp cpp-member docutils literal notranslate"><span class="pre">mfxInfoMFX::Quality</span></code></a>
parameter. In this case, the oneVPL encoder scales the default quantization table
according to the specified <a class="reference internal" href="../API_ref/VPL_structs_cross_component.html#_CPPv4N10mfxInfoMFX7QualityE" title="mfxInfoMFX::Quality"><code class="xref cpp cpp-member docutils literal notranslate"><span class="pre">mfxInfoMFX::Quality</span></code></a> parameter value.</p>
<p>The application should properly configure chroma sampling format and color
format using the <a class="reference internal" href="../API_ref/VPL_structs_memory.html#_CPPv4N12mfxFrameInfo6FourCCE" title="mfxFrameInfo::FourCC"><code class="xref cpp cpp-member docutils literal notranslate"><span class="pre">mfxFrameInfo::FourCC</span></code></a> and
<a class="reference internal" href="../API_ref/VPL_structs_memory.html#_CPPv4N12mfxFrameInfo12ChromaFormatE" title="mfxFrameInfo::ChromaFormat"><code class="xref cpp cpp-member docutils literal notranslate"><span class="pre">mfxFrameInfo::ChromaFormat</span></code></a> fields. For example, to encode a 4:2:2
vertically sampled YCbCr picture, the application should set
<a class="reference internal" href="../API_ref/VPL_structs_memory.html#_CPPv4N12mfxFrameInfo6FourCCE" title="mfxFrameInfo::FourCC"><code class="xref cpp cpp-member docutils literal notranslate"><span class="pre">mfxFrameInfo::FourCC</span></code></a> to <a class="reference internal" href="../API_ref/VPL_enums.html#_CPPv415MFX_FOURCC_YUY2" title="MFX_FOURCC_YUY2"><code class="xref cpp cpp-enumerator docutils literal notranslate"><span class="pre">MFX_FOURCC_YUY2</span></code></a> and
<a class="reference internal" href="../API_ref/VPL_structs_memory.html#_CPPv4N12mfxFrameInfo12ChromaFormatE" title="mfxFrameInfo::ChromaFormat"><code class="xref cpp cpp-member docutils literal notranslate"><span class="pre">mfxFrameInfo::ChromaFormat</span></code></a> to <a class="reference internal" href="../API_ref/VPL_enums.html#_CPPv424MFX_CHROMAFORMAT_YUV422V" title="MFX_CHROMAFORMAT_YUV422V"><code class="xref cpp cpp-enumerator docutils literal notranslate"><span class="pre">MFX_CHROMAFORMAT_YUV422V</span></code></a>.
To encode a 4:4:4 sampled RGB picture, the application should set
<a class="reference internal" href="../API_ref/VPL_structs_memory.html#_CPPv4N12mfxFrameInfo6FourCCE" title="mfxFrameInfo::FourCC"><code class="xref cpp cpp-member docutils literal notranslate"><span class="pre">mfxFrameInfo::FourCC</span></code></a> to <a class="reference internal" href="../API_ref/VPL_enums.html#_CPPv415MFX_FOURCC_RGB4" title="MFX_FOURCC_RGB4"><code class="xref cpp cpp-enumerator docutils literal notranslate"><span class="pre">MFX_FOURCC_RGB4</span></code></a> and
<a class="reference internal" href="../API_ref/VPL_structs_memory.html#_CPPv4N12mfxFrameInfo12ChromaFormatE" title="mfxFrameInfo::ChromaFormat"><code class="xref cpp cpp-member docutils literal notranslate"><span class="pre">mfxFrameInfo::ChromaFormat</span></code></a> to <a class="reference internal" href="../API_ref/VPL_enums.html#_CPPv423MFX_CHROMAFORMAT_YUV444" title="MFX_CHROMAFORMAT_YUV444"><code class="xref cpp cpp-enumerator docutils literal notranslate"><span class="pre">MFX_CHROMAFORMAT_YUV444</span></code></a>.</p>
<p>The oneVPL encoder supports different sets of chroma sampling and color formats on
different platforms. The application must call the <a class="reference internal" href="../API_ref/VPL_func_vid_encode.html#_CPPv420MFXVideoENCODE_Query10mfxSessionP13mfxVideoParamP13mfxVideoParam" title="MFXVideoENCODE_Query"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">MFXVideoENCODE_Query()</span></code></a>
function to check if the required color format is supported on a given platform
and then initialize the encoder with proper values of <a class="reference internal" href="../API_ref/VPL_structs_memory.html#_CPPv4N12mfxFrameInfo6FourCCE" title="mfxFrameInfo::FourCC"><code class="xref cpp cpp-member docutils literal notranslate"><span class="pre">mfxFrameInfo::FourCC</span></code></a>
and <a class="reference internal" href="../API_ref/VPL_structs_memory.html#_CPPv4N12mfxFrameInfo12ChromaFormatE" title="mfxFrameInfo::ChromaFormat"><code class="xref cpp cpp-member docutils literal notranslate"><span class="pre">mfxFrameInfo::ChromaFormat</span></code></a>.</p>
<p>The application should not define the number of scans and number of components.
These numbers are derived by the oneVPL encoder from the
<code class="xref cpp cpp-member docutils literal notranslate"><span class="pre">mfxInfoMFx::Interleaved</span></code> flag and from chroma type. If interleaved
coding is specified, then one scan is encoded that contains all image components.
Otherwise, the number of scans is equal to number of components. The encoder
uses the following component IDs:
“1” for luma (Y), “2” for chroma Cb (U), and “3” for chroma Cr (V).</p>
<p>The application should allocate a buffer that is big enough to hold the encoded
picture. A rough upper limit may be calculated using the following equation
where <strong>Width</strong> and <strong>Height</strong> are width and height of the picture in pixel and
<strong>BytesPerPx</strong> is the number of bytes for one pixel:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">BufferSizeInKB</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="n">Width</span> <span class="o">*</span> <span class="n">Height</span> <span class="o">*</span> <span class="n">BytesPerPx</span> <span class="o">+</span> <span class="mi">1023</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">;</span>
</pre></div>
</div>
<p>The equation equals 1 for a monochrome picture, 1.5 for NV12 and YV12 color
formats, 2 for YUY2 color format, and 3 for RGB32 color format (alpha channel is
not encoded).</p>
</div>
<div class="section" id="multi-view-video-encoding">
<h2>Multi-view Video Encoding<a class="headerlink" href="#multi-view-video-encoding" title="Permalink to this headline">¶</a></h2>
<p>Similar to the decoding and video processing initialization procedures, the
application attaches the <a class="reference internal" href="../API_ref/VPL_structs_cross_component.html#_CPPv416mfxExtMVCSeqDesc" title="mfxExtMVCSeqDesc"><code class="xref cpp cpp-struct docutils literal notranslate"><span class="pre">mfxExtMVCSeqDesc</span></code></a> structure to the
<a class="reference internal" href="../API_ref/VPL_structs_cross_component.html#_CPPv413mfxVideoParam" title="mfxVideoParam"><code class="xref cpp cpp-struct docutils literal notranslate"><span class="pre">mfxVideoParam</span></code></a> structure for encoding initialization. The
<a class="reference internal" href="../API_ref/VPL_structs_cross_component.html#_CPPv416mfxExtMVCSeqDesc" title="mfxExtMVCSeqDesc"><code class="xref cpp cpp-struct docutils literal notranslate"><span class="pre">mfxExtMVCSeqDesc</span></code></a> structure configures the oneVPL MVC encoder to work
in three modes:</p>
<ul class="simple">
<li><p><strong>Default dependency mode:</strong> The application specifies
<a class="reference internal" href="../API_ref/VPL_structs_cross_component.html#_CPPv4N16mfxExtMVCSeqDesc7NumViewE" title="mfxExtMVCSeqDesc::NumView"><code class="xref cpp cpp-member docutils literal notranslate"><span class="pre">mfxExtMVCSeqDesc::NumView</span></code></a> and all other fields to zero. The oneVPL
encoder creates a single operation point with all views (view identifier 0 :
NumView-1) as target views. The first view (view identifier 0) is the base view.
Other views depend on the base view.</p></li>
<li><p><strong>Explicit dependency mode:</strong> The application specifies
<a class="reference internal" href="../API_ref/VPL_structs_cross_component.html#_CPPv4N16mfxExtMVCSeqDesc7NumViewE" title="mfxExtMVCSeqDesc::NumView"><code class="xref cpp cpp-member docutils literal notranslate"><span class="pre">mfxExtMVCSeqDesc::NumView</span></code></a> and the view dependency array, and sets
all other fields to zero. The oneVPL encoder creates a single operation point with
all views (view identifier View[0 : NumView-1].ViewId) as target views. The
first view (view identifier View[0].ViewId) is the base view. View dependencies
are defined as <a class="reference internal" href="../API_ref/VPL_structs_cross_component.html#_CPPv420mfxMVCViewDependency" title="mfxMVCViewDependency"><code class="xref cpp cpp-struct docutils literal notranslate"><span class="pre">mfxMVCViewDependency</span></code></a> structures.</p></li>
<li><p><strong>Complete mode:</strong> The application fully specifies the views and their
dependencies. The oneVPL encoder generates a bitstream with corresponding stream
structures.</p></li>
</ul>
<p>During encoding, the oneVPL encoding function <a class="reference internal" href="../API_ref/VPL_func_vid_encode.html#_CPPv431MFXVideoENCODE_EncodeFrameAsync10mfxSessionP13mfxEncodeCtrlP16mfxFrameSurface1P12mfxBitstreamP12mfxSyncPoint" title="MFXVideoENCODE_EncodeFrameAsync"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">MFXVideoENCODE_EncodeFrameAsync()</span></code></a>
accumulates input frames until encoding of a picture is possible. The function
returns <a class="reference internal" href="../API_ref/VPL_enums.html#_CPPv4N9mfxStatus17MFX_ERR_MORE_DATAE" title="mfxStatus::MFX_ERR_MORE_DATA"><code class="xref cpp cpp-enumerator docutils literal notranslate"><span class="pre">mfxStatus::MFX_ERR_MORE_DATA</span></code></a> for more data at input or
<a class="reference internal" href="../API_ref/VPL_enums.html#_CPPv4N9mfxStatus12MFX_ERR_NONEE" title="mfxStatus::MFX_ERR_NONE"><code class="xref cpp cpp-enumerator docutils literal notranslate"><span class="pre">mfxStatus::MFX_ERR_NONE</span></code></a> if it successfully accumulated enough data for
encoding a picture. The generated bitstream contains the complete picture
(multiple views). The application can change this behavior and instruct the
encoder to output each view in a separate bitstream buffer. To do so, the
application must turn on the <a class="reference internal" href="../API_ref/VPL_structs_encode.html#_CPPv4N18mfxExtCodingOption10ViewOutputE" title="mfxExtCodingOption::ViewOutput"><code class="xref cpp cpp-member docutils literal notranslate"><span class="pre">mfxExtCodingOption::ViewOutput</span></code></a> flag.
In this case, the encoder returns <a class="reference internal" href="../API_ref/VPL_enums.html#_CPPv4N9mfxStatus22MFX_ERR_MORE_BITSTREAME" title="mfxStatus::MFX_ERR_MORE_BITSTREAM"><code class="xref cpp cpp-enumerator docutils literal notranslate"><span class="pre">mfxStatus::MFX_ERR_MORE_BITSTREAM</span></code></a>
if it needs more bitstream buffers at output and
<a class="reference internal" href="../API_ref/VPL_enums.html#_CPPv4N9mfxStatus12MFX_ERR_NONEE" title="mfxStatus::MFX_ERR_NONE"><code class="xref cpp cpp-enumerator docutils literal notranslate"><span class="pre">mfxStatus::MFX_ERR_NONE</span></code></a> when processing of the
picture (multiple views) has been finished. It is recommended that the application
provide a new input frame each time the oneVPL encoder requests a new bitstream buffer.
The application must submit view data for encoding in the order they are
described in the <a class="reference internal" href="../API_ref/VPL_structs_cross_component.html#_CPPv416mfxExtMVCSeqDesc" title="mfxExtMVCSeqDesc"><code class="xref cpp cpp-struct docutils literal notranslate"><span class="pre">mfxExtMVCSeqDesc</span></code></a> structure. Particular view data
can be submitted for encoding only when all views that it depends upon have
already been submitted.</p>
<p>The following pseudo code shows the encoding procedure:</p>
<div class="highlight-c++ notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">mfxExtBuffer</span> <span class="o">*</span><span class="n">eb</span><span class="p">;</span>
<span class="n">mfxExtMVCSeqDesc</span>  <span class="n">seq_desc</span><span class="p">;</span>
<span class="n">mfxVideoParam</span> <span class="n">init_param</span><span class="p">;</span>

<span class="n">init_param</span><span class="p">.</span><span class="n">ExtParam</span><span class="o">=</span><span class="p">(</span><span class="n">mfxExtBuffer</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">eb</span><span class="p">;</span>
<span class="n">init_param</span><span class="p">.</span><span class="n">NumExtParam</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
<span class="n">eb</span><span class="o">=</span><span class="p">(</span><span class="n">mfxExtBuffer</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">seq_desc</span><span class="p">;</span>

<span class="cm">/* init encoder */</span>
<span class="n">MFXVideoENCODE_Init</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">init_param</span><span class="p">);</span>

<span class="cm">/* perform encoding */</span>
<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
    <span class="n">MFXVideoENCODE_EncodeFrameAsync</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">surface2</span><span class="p">,</span> <span class="n">bits</span><span class="p">,</span>
                                    <span class="o">&amp;</span><span class="n">syncp</span><span class="p">);</span>
    <span class="n">MFXVideoCORE_SyncOperation</span><span class="p">(</span><span class="n">session</span><span class="p">,</span><span class="n">syncp</span><span class="p">,</span><span class="n">INFINITE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* close encoder */</span>
<span class="n">MFXVideoENCODE_Close</span><span class="p">(</span><span class="n">session</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="VPL_prg_vpp.html" class="btn btn-neutral float-right" title="Video Processing Procedures" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="VPL_prg_decoding.html" class="btn btn-neutral float-left" title="Decoding Procedures" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, Intel Corporation

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>
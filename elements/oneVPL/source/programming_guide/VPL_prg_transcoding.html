<!--
SPDX-FileCopyrightText: 2019-2020 Intel Corporation

SPDX-License-Identifier: MIT
-->



<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Transcoding Procedures &mdash; oneAPI Specification 1.0 documentation</title>
  

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../../../_static/favicons.png"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/doctools.js"></script>
        <script src="../../../../_static/language_data.js"></script>
        <script src="../../../../_static/custom.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link rel="next" title="Hardware Acceleration" href="VPL_prg_hw.html" />
    <link rel="prev" title="Video Processing Procedures" href="VPL_prg_vpp.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="https://oneapi.com" class="icon icon-home"> oneAPI Specification
          

          
            
            <img src="../../../../_static/oneAPI-rgb-rev-100.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../../architecture.html">Software Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../library-interop.html">Library Interoperability</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../elements.html">oneAPI Elements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dpcpp/source/index.html">DPC++</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../oneDPL/source/index.html">oneDPL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../oneDNN/source/index.html">oneDNN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../oneCCL/source/index.html">oneCCL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../l0/source/index.html">Level Zero</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../oneDAL/source/index.html">oneDAL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../oneTBB/source/nested-index.html">oneTBB</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">oneVPL</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../architecture/index.html">Architecture</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Programming Guide</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="VPL_prg_stc.html">Status Codes</a></li>
<li class="toctree-l3"><a class="reference internal" href="VPL_prg_session.html">oneVPL Session</a></li>
<li class="toctree-l3"><a class="reference internal" href="VPL_prg_frame.html">Frame and Fields</a></li>
<li class="toctree-l3"><a class="reference internal" href="VPL_prg_decoding.html">Decoding Procedures</a></li>
<li class="toctree-l3"><a class="reference internal" href="VPL_prg_encoding.html">Encoding Procedures</a></li>
<li class="toctree-l3"><a class="reference internal" href="VPL_prg_vpp.html">Video Processing Procedures</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Transcoding Procedures</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#asynchronous-pipeline">Asynchronous Pipeline</a></li>
<li class="toctree-l4"><a class="reference internal" href="#surface-pool-allocation">Surface Pool Allocation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#pipeline-error-reporting">Pipeline Error Reporting</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="VPL_prg_hw.html">Hardware Acceleration</a></li>
<li class="toctree-l3"><a class="reference internal" href="VPL_prg_mem.html">Memory Allocation and External Allocators</a></li>
<li class="toctree-l3"><a class="reference internal" href="VPL_prg_err.html">Hardware Device Error Handling</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../VPL_summary.html">Mandatory APIs and Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../API_ref/VPL_api_ref.html">oneVPL API Reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Versioning.html">oneVPL API Versioning</a></li>
<li class="toctree-l2"><a class="reference internal" href="../appendix/index.html">Appendices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../VPL_acronyms.html">Glossary</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../oneMKL/source/index.html">oneMKL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../contributors.html">Contributors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../versions.html">HTML and PDF Versions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notices.html">Legal Notices and Disclaimers</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">oneAPI Specification</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          <!--
SPDX-FileCopyrightText: 2019-2020 Intel Corporation

SPDX-License-Identifier: MIT
-->

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html">oneAPI Specification</a> &raquo;</li>
        
          
          <li><a href="../index.html">oneVPL</a> </li>
          
        
          
        
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            
              <a href="https://github.com/oneapi-src/oneapi-spec/blob/master/source/elements/oneVPL/source/programming_guide/VPL_prg_transcoding.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="transcoding-procedures">
<h1>Transcoding Procedures<a class="headerlink" href="#transcoding-procedures" title="Permalink to this headline">¶</a></h1>
<p>The application can use oneVPL encoding, decoding, and video processing
functions together for transcoding operations. This section describes the key
aspects of connecting two or more oneVPL functions together.</p>
<div class="section" id="asynchronous-pipeline">
<h2>Asynchronous Pipeline<a class="headerlink" href="#asynchronous-pipeline" title="Permalink to this headline">¶</a></h2>
<p>The application passes the output of an upstream oneVPL function to the input of
the downstream oneVPL function to construct an asynchronous pipeline. Pipeline
construction is done at runtime and can be dynamically changed, as shown in the
following example:</p>
<div class="highlight-c++ notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">mfxSyncPoint</span> <span class="n">sp_d</span><span class="p">,</span> <span class="n">sp_e</span><span class="p">;</span>
<span class="n">MFXVideoDECODE_DecodeFrameAsync</span><span class="p">(</span><span class="n">session</span><span class="p">,</span><span class="n">bs</span><span class="p">,</span><span class="n">work</span><span class="p">,</span><span class="o">&amp;</span><span class="n">vin</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sp_d</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">going_through_vpp</span><span class="p">)</span> <span class="p">{</span>
   <span class="n">MFXVideoVPP_RunFrameVPPAsync</span><span class="p">(</span><span class="n">session</span><span class="p">,</span><span class="n">vin</span><span class="p">,</span><span class="n">vout</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sp_d</span><span class="p">);</span>
   <span class="n">MFXVideoENCODE_EncodeFrameAsync</span><span class="p">(</span><span class="n">session</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="n">vout</span><span class="p">,</span><span class="n">bits2</span><span class="p">,</span><span class="o">&amp;</span><span class="n">sp_e</span><span class="p">);</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
   <span class="n">MFXVideoENCODE_EncodeFrameAsync</span><span class="p">(</span><span class="n">session</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="n">vin</span><span class="p">,</span><span class="n">bits2</span><span class="p">,</span><span class="o">&amp;</span><span class="n">sp_e</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">MFXVideoCORE_SyncOperation</span><span class="p">(</span><span class="n">session</span><span class="p">,</span><span class="n">sp_e</span><span class="p">,</span><span class="n">INFINITE</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
<p>oneVPL simplifies the requirements for asynchronous pipeline synchronization.
The application only needs to synchronize after the last oneVPL function. Explicit
synchronization of intermediate results is not required and may slow performance.</p>
<p>oneVPL tracks dynamic pipeline construction and verifies dependency on input
and output parameters to ensure the execution order of the pipeline function.
In the previous example, oneVPL will ensure <a class="reference internal" href="../API_ref/VPL_func_vid_encode.html#_CPPv431MFXVideoENCODE_EncodeFrameAsync10mfxSessionP13mfxEncodeCtrlP16mfxFrameSurface1P12mfxBitstreamP12mfxSyncPoint" title="MFXVideoENCODE_EncodeFrameAsync"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">MFXVideoENCODE_EncodeFrameAsync()</span></code></a>
does not begin its operation until <a class="reference internal" href="../API_ref/VPL_func_vid_decode.html#_CPPv431MFXVideoDECODE_DecodeFrameAsync10mfxSessionP12mfxBitstreamP16mfxFrameSurface1PP16mfxFrameSurface1P12mfxSyncPoint" title="MFXVideoDECODE_DecodeFrameAsync"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">MFXVideoDECODE_DecodeFrameAsync()</span></code></a> or
<a class="reference internal" href="../API_ref/VPL_func_vid_vpp.html#_CPPv428MFXVideoVPP_RunFrameVPPAsync10mfxSessionP16mfxFrameSurface1P16mfxFrameSurface1P16mfxExtVppAuxDataP12mfxSyncPoint" title="MFXVideoVPP_RunFrameVPPAsync"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">MFXVideoVPP_RunFrameVPPAsync()</span></code></a> has finished.</p>
<p>During the execution of an asynchronous pipeline, the application must consider
the input data as “in use” and must not change it until the execution has completed.
The application must also consider output data unavailable until the execution
has finished. In addition, for encoders, the application must consider extended
and payload buffers as “in use” while the input surface is locked.</p>
<p>oneVPL checks dependencies by comparing the input and output parameters of each
oneVPL function in the pipeline. Do not modify the contents of input and output
parameters before the previous asynchronous operation finishes. Doing so will
break the dependency check and can result in undefined behavior. An exception
occurs when the input and output parameters are structures, in which case
overwriting fields in the structures is allowed.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The dependency check works on the pointers to the structures only.</p>
</div>
<p>There are two exceptions with respect to intermediate synchronization:</p>
<ul class="simple">
<li><p>If the input is from any asynchronous operation, the application must
synchronize any input before calling the oneVPL <a class="reference internal" href="../API_ref/VPL_func_vid_decode.html#_CPPv431MFXVideoDECODE_DecodeFrameAsync10mfxSessionP12mfxBitstreamP16mfxFrameSurface1PP16mfxFrameSurface1P12mfxSyncPoint" title="MFXVideoDECODE_DecodeFrameAsync"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">MFXVideoDECODE_DecodeFrameAsync()</span></code></a>
function.</p></li>
<li><p>When the application calls an asynchronous function to generate an output
surface in video memory and passes that surface to a non-oneVPL component, it must
explicitly synchronize the operation before passing the surface to the non-oneVPL
component.</p></li>
</ul>
</div>
<div class="section" id="surface-pool-allocation">
<span id="surface-pool-alloc"></span><h2>Surface Pool Allocation<a class="headerlink" href="#surface-pool-allocation" title="Permalink to this headline">¶</a></h2>
<p>When connecting API function <strong>A</strong> to API function <strong>B</strong>, the application must
take into account the requirements of both functions to calculate the number of
frame surfaces in the surface pool. Typically, the application can use the formula
<strong>Na+Nb</strong>, where <strong>Na</strong> is the frame surface requirements for oneVPL function <strong>A</strong>
output, and <strong>Nb</strong> is the frame surface requirements for oneVPL function <strong>B</strong> input.</p>
<p>For performance considerations, the application must submit multiple operations
and delay synchronization as much as possible, which gives oneVPL flexibility
to organize internal pipelining. For example, compare the following two operation
sequences, where the first sequence is the recommended order:</p>
<div class="figure align-default" id="id1">
<div class="graphviz"><img src="../../../../_images/graphviz-1d3aa857b4784f656d4eac77e4266e8349f08e34.png" alt="digraph {
   rankdir=LR;
   labelloc=&quot;t&quot;;
   label=&quot;Operation sequence 1&quot;;
   f1 [shape=record label=&quot;ENCODE(F1)&quot; ];
   f2 [shape=record label=&quot;ENCODE(F2)&quot; ];
   f3 [shape=record label=&quot;SYNC(F1)&quot; ];
   f4 [shape=record label=&quot;SYNC(F2)&quot; ];
   f1-&gt;f2-&gt;f3-&gt;f4;
}" class="graphviz" /></div>
<p class="caption"><span class="caption-text">Recommended operation sequence</span><a class="headerlink" href="#id1" title="Permalink to this image">¶</a></p>
</div>
<div class="figure align-default" id="id2">
<div class="graphviz"><img src="../../../../_images/graphviz-5a3d1fe20eb74b213cfce550b4f5465cdbfc9178.png" alt="digraph {
   rankdir=LR;
   labelloc=&quot;t&quot;;
   label=&quot;Operation sequence 2&quot;;
   f1 [shape=record label=&quot;ENCODE(F1)&quot; ];
   f2 [shape=record label=&quot;ENCODE(F2)&quot; ];
   f3 [shape=record label=&quot;SYNC(F1)&quot; ];
   f4 [shape=record label=&quot;SYNC(F2)&quot; ];
   f1-&gt;f3-&gt;f2-&gt;f4;
}" class="graphviz" /></div>
<p class="caption"><span class="caption-text">Operation sequence - not recommended</span><a class="headerlink" href="#id2" title="Permalink to this image">¶</a></p>
</div>
<p>In this example, the surface pool needs additional surfaces to take into account
multiple asynchronous operations before synchronization. The application can use
the <a class="reference internal" href="../API_ref/VPL_structs_cross_component.html#_CPPv4N13mfxVideoParam10AsyncDepthE" title="mfxVideoParam::AsyncDepth"><code class="xref cpp cpp-member docutils literal notranslate"><span class="pre">mfxVideoParam::AsyncDepth</span></code></a> field to inform a oneVPL function of
the number of asynchronous operations the application plans to perform before
synchronization. The corresponding oneVPL <strong>QueryIOSurf</strong> function will reflect
this number in the <a class="reference internal" href="../API_ref/VPL_structs_memory.html#_CPPv4N20mfxFrameAllocRequest17NumFrameSuggestedE" title="mfxFrameAllocRequest::NumFrameSuggested"><code class="xref cpp cpp-member docutils literal notranslate"><span class="pre">mfxFrameAllocRequest::NumFrameSuggested</span></code></a>
value. The following example shows a way of calculating the surface needs based
on <a class="reference internal" href="../API_ref/VPL_structs_memory.html#_CPPv4N20mfxFrameAllocRequest17NumFrameSuggestedE" title="mfxFrameAllocRequest::NumFrameSuggested"><code class="xref cpp cpp-member docutils literal notranslate"><span class="pre">mfxFrameAllocRequest::NumFrameSuggested</span></code></a> values:</p>
<div class="highlight-c++ notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">mfxVideoParam</span> <span class="n">init_param_v</span><span class="p">,</span> <span class="n">init_param_e</span><span class="p">;</span>
<span class="n">mfxFrameAllocRequest</span> <span class="n">response_v</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">response_e</span><span class="p">;</span>

<span class="c1">// Desired depth</span>
<span class="n">mfxU16</span> <span class="n">async_depth</span><span class="o">=</span><span class="mi">4</span><span class="p">;</span>

<span class="n">init_param_v</span><span class="p">.</span><span class="n">AsyncDepth</span><span class="o">=</span><span class="n">async_depth</span><span class="p">;</span>
<span class="n">MFXVideoVPP_QueryIOSurf</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">init_param_v</span><span class="p">,</span> <span class="n">response_v</span><span class="p">);</span>
<span class="n">init_param_e</span><span class="p">.</span><span class="n">AsyncDepth</span><span class="o">=</span><span class="n">async_depth</span><span class="p">;</span>
<span class="n">MFXVideoENCODE_QueryIOSurf</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">init_param_e</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">response_e</span><span class="p">);</span>
<span class="n">mfxU32</span> <span class="n">num_surfaces</span><span class="o">=</span>    <span class="n">response_v</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">NumFrameSuggested</span>
         <span class="o">+</span><span class="n">response_e</span><span class="p">.</span><span class="n">NumFrameSuggested</span>
         <span class="o">-</span><span class="n">async_depth</span><span class="p">;</span> <span class="cm">/* double counted in ENCODE &amp; VPP */</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="pipeline-error-reporting">
<h2>Pipeline Error Reporting<a class="headerlink" href="#pipeline-error-reporting" title="Permalink to this headline">¶</a></h2>
<p>During asynchronous pipeline construction, each pipeline stage function will
return a synchronization point (sync point). These synchronization points are
useful in tracking errors during the asynchronous pipeline operation.</p>
<p>For example, assume the following pipeline:</p>
<div class="graphviz"><img src="../../../../_images/graphviz-afb8259d26d0164efda5a9ab3f08532191385dea.png" alt="digraph {
   rankdir=LR;
   A-&gt;B-&gt;C;
}" class="graphviz" /></div>
<p>The application synchronizes on sync point <strong>C</strong>. If the error occurs in
function <strong>C</strong>, then the synchronization returns the exact error code. If the
error occurs before function <strong>C</strong>, then the synchronization returns
<a class="reference internal" href="../API_ref/VPL_enums.html#_CPPv4N9mfxStatus15MFX_ERR_ABORTEDE" title="mfxStatus::MFX_ERR_ABORTED"><code class="xref cpp cpp-enumerator docutils literal notranslate"><span class="pre">mfxStatus::MFX_ERR_ABORTED</span></code></a>. The application can then try to
synchronize on sync point <strong>B</strong>. Similarly, if the error occurs in function <strong>B</strong>,
the synchronization returns the exact error code, or else
<a class="reference internal" href="../API_ref/VPL_enums.html#_CPPv4N9mfxStatus15MFX_ERR_ABORTEDE" title="mfxStatus::MFX_ERR_ABORTED"><code class="xref cpp cpp-enumerator docutils literal notranslate"><span class="pre">mfxStatus::</span> <span class="pre">MFX_ERR_ABORTED</span></code></a>. The same logic applies if the
error occurs in function <strong>A</strong>.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="VPL_prg_hw.html" class="btn btn-neutral float-right" title="Hardware Acceleration" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="VPL_prg_vpp.html" class="btn btn-neutral float-left" title="Video Processing Procedures" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, Intel Corporation

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>
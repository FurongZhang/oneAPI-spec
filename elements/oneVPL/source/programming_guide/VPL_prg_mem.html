<!--
SPDX-FileCopyrightText: 2019-2020 Intel Corporation

SPDX-License-Identifier: MIT
-->



<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Memory Allocation and External Allocators &mdash; oneAPI Specification 1.0-rev-2 documentation</title>
  

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../../../_static/favicons.png"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/doctools.js"></script>
        <script src="../../../../_static/language_data.js"></script>
        <script src="../../../../_static/custom.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link rel="next" title="Hardware Device Error Handling" href="VPL_prg_err.html" />
    <link rel="prev" title="Hardware Acceleration" href="VPL_prg_hw.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="https://oneapi.com" class="icon icon-home"> oneAPI Specification
          

          
            
            <img src="../../../../_static/oneAPI-rgb-rev-100.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                1.0-rev-2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../architecture.html">Software Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dpcpp/source/index.html">DPC++</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../oneDPL/source/index.html">oneDPL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../oneDNN/source/index.html">oneDNN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../oneCCL/source/index.html">oneCCL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../l0/source/index.html">Level Zero</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../oneDAL/source/index.html">oneDAL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../oneTBB/source/nested-index.html">oneTBB</a></li>
<li class="toctree-l1"><a class="reference internal" href="../index.html">oneVPL</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html#onevpl-specification-version">oneVPL Specification Version</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../architecture/index.html">Architecture</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Programming Guide</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="VPL_prg_stc.html">Status Codes</a></li>
<li class="toctree-l3"><a class="reference internal" href="VPL_prg_session.html">oneVPL Session</a></li>
<li class="toctree-l3"><a class="reference internal" href="VPL_prg_frame.html">Frame and Fields</a></li>
<li class="toctree-l3"><a class="reference internal" href="VPL_prg_decoding.html">Decoding Procedures</a></li>
<li class="toctree-l3"><a class="reference internal" href="VPL_prg_encoding.html">Encoding Procedures</a></li>
<li class="toctree-l3"><a class="reference internal" href="VPL_prg_vpp.html">Video Processing Procedures</a></li>
<li class="toctree-l3"><a class="reference internal" href="VPL_prg_transcoding.html">Transcoding Procedures</a></li>
<li class="toctree-l3"><a class="reference internal" href="VPL_prg_hw.html">Hardware Acceleration</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Memory Allocation and External Allocators</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#external-memory-management">External Memory Management</a></li>
<li class="toctree-l4"><a class="reference internal" href="#internal-memory-management">Internal Memory Management</a></li>
<li class="toctree-l4"><a class="reference internal" href="#mfxframesurfaceinterface">mfxFrameSurfaceInterface</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="VPL_prg_err.html">Hardware Device Error Handling</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../VPL_summary.html">Mandatory APIs and Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../API_ref/VPL_api_ref.html">oneVPL API Reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Versioning.html">oneVPL API Versioning</a></li>
<li class="toctree-l2"><a class="reference internal" href="../appendix/index.html">Appendices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../VPL_acronyms.html">Glossary</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../oneMKL/source/index.html">oneMKL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../versions.html">HTML and PDF Versions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notices.html">Legal Notices and Disclaimers</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">oneAPI Specification</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          <!--
SPDX-FileCopyrightText: 2019-2020 Intel Corporation

SPDX-License-Identifier: MIT
-->

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html">oneAPI Specification</a> &raquo;</li>
        
          
          <li><a href="../index.html">oneVPL</a> </li>
          
        
          
        
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            
              <a href="https://github.com/oneapi-src/oneapi-spec/blob/master/source/elements/oneVPL/source/programming_guide/VPL_prg_mem.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="memory-allocation-and-external-allocators">
<span id="mem-alloc-ext-alloc"></span><h1>Memory Allocation and External Allocators<a class="headerlink" href="#memory-allocation-and-external-allocators" title="Permalink to this headline">¶</a></h1>
<p>There are two models of memory management in oneVPL: internal and external.</p>
<div class="section" id="external-memory-management">
<h2>External Memory Management<a class="headerlink" href="#external-memory-management" title="Permalink to this headline">¶</a></h2>
<p>In the external memory model, the application must allocate sufficient memory for
input and output parameters and buffers and deallocate it when oneVPL functions
complete their operations. During execution, the oneVPL functions use callback
functions to the application to manage memory for video frames through the
external allocator interface <a class="reference internal" href="../API_ref/VPL_structs_memory.html#_CPPv417mfxFrameAllocator" title="mfxFrameAllocator"><code class="xref cpp cpp-struct docutils literal notranslate"><span class="pre">mfxFrameAllocator</span></code></a>.</p>
<p>If an application needs to control the allocation of video frames, it can use
callback functions through the <a class="reference internal" href="../API_ref/VPL_structs_memory.html#_CPPv417mfxFrameAllocator" title="mfxFrameAllocator"><code class="xref cpp cpp-struct docutils literal notranslate"><span class="pre">mfxFrameAllocator</span></code></a> interface. If an
application does not specify an allocator, an internal allocator is used. However,
if an application uses video memory surfaces for input and output, it must specify
the hardware acceleration device and an external frame allocator using
<a class="reference internal" href="../API_ref/VPL_structs_memory.html#_CPPv417mfxFrameAllocator" title="mfxFrameAllocator"><code class="xref cpp cpp-struct docutils literal notranslate"><span class="pre">mfxFrameAllocator</span></code></a>.</p>
<p>The external frame allocator can allocate different frame types:</p>
<ul class="simple">
<li><p>In-system memory.</p></li>
<li><p>In-video memory, as ‘Decoder Render Targets’ or ‘Processor Render Targets.’
See <a class="reference internal" href="VPL_prg_hw.html#hw-acceleration"><span class="std std-ref">Working with Hardware Acceleration</span></a> for additional
details.</p></li>
</ul>
<p>The external frame allocator responds only to frame allocation requests for the
requested memory type and returns <a class="reference internal" href="../API_ref/VPL_enums.html#_CPPv4N9mfxStatus19MFX_ERR_UNSUPPORTEDE" title="mfxStatus::MFX_ERR_UNSUPPORTED"><code class="xref cpp cpp-enumerator docutils literal notranslate"><span class="pre">mfxStatus::MFX_ERR_UNSUPPORTED</span></code></a>
for all other types. The allocation request uses flags (part of the memory type
field) to indicate which oneVPL class initiated the request so that the external
frame allocator can respond accordingly.</p>
<p>The following example shows a simple external frame allocator:</p>
<div class="highlight-c++ notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">#define ALIGN32(X) (((mfxU32)((X)+31)) &amp; (~ (mfxU32)31))</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
   <span class="n">mfxU16</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">;</span>
   <span class="n">mfxU8</span> <span class="o">*</span><span class="n">base</span><span class="p">;</span>
<span class="p">}</span> <span class="n">mid_struct</span><span class="p">;</span>

<span class="n">mfxStatus</span> <span class="nf">fa_alloc</span><span class="p">(</span><span class="n">mfxHDL</span> <span class="n">pthis</span><span class="p">,</span> <span class="n">mfxFrameAllocRequest</span> <span class="o">*</span><span class="n">request</span><span class="p">,</span> <span class="n">mfxFrameAllocResponse</span> <span class="o">*</span><span class="n">response</span><span class="p">)</span> <span class="p">{</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">Type</span><span class="o">&amp;</span><span class="n">MFX_MEMTYPE_SYSTEM_MEMORY</span><span class="p">))</span>
      <span class="k">return</span> <span class="n">MFX_ERR_UNSUPPORTED</span><span class="p">;</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">Info</span><span class="p">.</span><span class="n">FourCC</span><span class="o">!=</span><span class="n">MFX_FOURCC_NV12</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">MFX_ERR_UNSUPPORTED</span><span class="p">;</span>
   <span class="n">response</span><span class="o">-&gt;</span><span class="n">NumFrameActual</span><span class="o">=</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">NumFrameMin</span><span class="p">;</span>
   <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">NumFrameMin</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">mid_struct</span> <span class="o">*</span><span class="n">mmid</span><span class="o">=</span><span class="p">(</span><span class="n">mid_struct</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">mid_struct</span><span class="p">));</span>
      <span class="n">mmid</span><span class="o">-&gt;</span><span class="n">width</span><span class="o">=</span><span class="n">ALIGN32</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">Info</span><span class="p">.</span><span class="n">Width</span><span class="p">);</span>
      <span class="n">mmid</span><span class="o">-&gt;</span><span class="n">height</span><span class="o">=</span><span class="n">ALIGN32</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">Info</span><span class="p">.</span><span class="n">Height</span><span class="p">);</span>
      <span class="n">mmid</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">=</span><span class="p">(</span><span class="n">mfxU8</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">mmid</span><span class="o">-&gt;</span><span class="n">width</span><span class="o">*</span><span class="n">mmid</span><span class="o">-&gt;</span><span class="n">height</span><span class="o">*</span><span class="mi">3</span><span class="o">/</span><span class="mi">2</span><span class="p">);</span>
      <span class="n">response</span><span class="o">-&gt;</span><span class="n">mids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">mmid</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="k">return</span> <span class="n">MFX_ERR_NONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">mfxStatus</span> <span class="nf">fa_lock</span><span class="p">(</span><span class="n">mfxHDL</span> <span class="n">pthis</span><span class="p">,</span> <span class="n">mfxMemId</span> <span class="n">mid</span><span class="p">,</span> <span class="n">mfxFrameData</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span> <span class="p">{</span>
   <span class="n">mid_struct</span> <span class="o">*</span><span class="n">mmid</span><span class="o">=</span><span class="p">(</span><span class="n">mid_struct</span> <span class="o">*</span><span class="p">)</span><span class="n">mid</span><span class="p">;</span>
   <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">Pitch</span><span class="o">=</span><span class="n">mmid</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
   <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">Y</span><span class="o">=</span><span class="n">mmid</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
   <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">U</span><span class="o">=</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">Y</span><span class="o">+</span><span class="n">mmid</span><span class="o">-&gt;</span><span class="n">width</span><span class="o">*</span><span class="n">mmid</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
   <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">V</span><span class="o">=</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">U</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
   <span class="k">return</span> <span class="n">MFX_ERR_NONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">mfxStatus</span> <span class="nf">fa_unlock</span><span class="p">(</span><span class="n">mfxHDL</span> <span class="n">pthis</span><span class="p">,</span> <span class="n">mfxMemId</span> <span class="n">mid</span><span class="p">,</span> <span class="n">mfxFrameData</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span> <span class="p">{</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="p">)</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">Y</span><span class="o">=</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">U</span><span class="o">=</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">V</span><span class="o">=</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">A</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
   <span class="k">return</span> <span class="n">MFX_ERR_NONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">mfxStatus</span> <span class="nf">fa_gethdl</span><span class="p">(</span><span class="n">mfxHDL</span> <span class="n">pthis</span><span class="p">,</span> <span class="n">mfxMemId</span> <span class="n">mid</span><span class="p">,</span> <span class="n">mfxHDL</span> <span class="o">*</span><span class="n">handle</span><span class="p">)</span> <span class="p">{</span>
   <span class="k">return</span> <span class="n">MFX_ERR_UNSUPPORTED</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">mfxStatus</span> <span class="nf">fa_free</span><span class="p">(</span><span class="n">mfxHDL</span> <span class="n">pthis</span><span class="p">,</span> <span class="n">mfxFrameAllocResponse</span> <span class="o">*</span><span class="n">response</span><span class="p">)</span> <span class="p">{</span>
   <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">response</span><span class="o">-&gt;</span><span class="n">NumFrameActual</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">mid_struct</span> <span class="o">*</span><span class="n">mmid</span><span class="o">=</span><span class="p">(</span><span class="n">mid_struct</span> <span class="o">*</span><span class="p">)</span><span class="n">response</span><span class="o">-&gt;</span><span class="n">mids</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
      <span class="n">free</span><span class="p">(</span><span class="n">mmid</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span> <span class="n">free</span><span class="p">(</span><span class="n">mmid</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="k">return</span> <span class="n">MFX_ERR_NONE</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>For system memory, it is highly recommended to allocate memory for all
planes of the same frame as a single buffer (using one single malloc call).</p>
</div>
<div class="section" id="internal-memory-management">
<span id="internal-mem-manage"></span><h2>Internal Memory Management<a class="headerlink" href="#internal-memory-management" title="Permalink to this headline">¶</a></h2>
<p>In the internal memory management model, oneVPL provides interface functions for
frames allocation:</p>
<ul class="simple">
<li><p><a class="reference internal" href="../API_ref/VPL_func_mem.html#_CPPv426MFXMemory_GetSurfaceForVPP10mfxSessionPP16mfxFrameSurface1" title="MFXMemory_GetSurfaceForVPP"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">MFXMemory_GetSurfaceForVPP()</span></code></a></p></li>
<li><p><a class="reference internal" href="../API_ref/VPL_func_mem.html#_CPPv429MFXMemory_GetSurfaceForVPPOut10mfxSessionPP16mfxFrameSurface1" title="MFXMemory_GetSurfaceForVPPOut"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">MFXMemory_GetSurfaceForVPPOut()</span></code></a></p></li>
<li><p><a class="reference internal" href="../API_ref/VPL_func_mem.html#_CPPv429MFXMemory_GetSurfaceForEncode10mfxSessionPP16mfxFrameSurface1" title="MFXMemory_GetSurfaceForEncode"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">MFXMemory_GetSurfaceForEncode()</span></code></a></p></li>
<li><p><a class="reference internal" href="../API_ref/VPL_func_mem.html#_CPPv429MFXMemory_GetSurfaceForDecode10mfxSessionPP16mfxFrameSurface1" title="MFXMemory_GetSurfaceForDecode"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">MFXMemory_GetSurfaceForDecode()</span></code></a></p></li>
</ul>
<p>These functions are used together with <a class="reference internal" href="../API_ref/VPL_structs_memory.html#_CPPv424mfxFrameSurfaceInterface" title="mfxFrameSurfaceInterface"><code class="xref cpp cpp-struct docutils literal notranslate"><span class="pre">mfxFrameSurfaceInterface</span></code></a>
for surface management. The surface returned by these functions is a reference
counted object and the application must call <a class="reference internal" href="../API_ref/VPL_structs_memory.html#_CPPv4N24mfxFrameSurfaceInterface7ReleaseE" title="mfxFrameSurfaceInterface::Release"><code class="xref cpp cpp-member docutils literal notranslate"><span class="pre">mfxFrameSurfaceInterface::Release</span></code></a>
after finishing all operations with the surface. In this model the application
does not need to create and set the external allocator to oneVPL.</p>
<p>Another method to obtain an internally allocated surface is to call
<a class="reference internal" href="../API_ref/VPL_func_vid_decode.html#_CPPv431MFXVideoDECODE_DecodeFrameAsync10mfxSessionP12mfxBitstreamP16mfxFrameSurface1PP16mfxFrameSurface1P12mfxSyncPoint" title="MFXVideoDECODE_DecodeFrameAsync"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">MFXVideoDECODE_DecodeFrameAsync()</span></code></a> with a working surface equal to NULL
(see <a class="reference internal" href="VPL_prg_decoding.html#simplified-decoding-procedure"><span class="std std-ref">Simplified decoding procedure</span></a>). In
this scenario, the decoder will allocate a new refcountable
<a class="reference internal" href="../API_ref/VPL_structs_memory.html#_CPPv416mfxFrameSurface1" title="mfxFrameSurface1"><code class="xref cpp cpp-struct docutils literal notranslate"><span class="pre">mfxFrameSurface1</span></code></a> and return it to the user. All assumed contracts
with the user are similar to the <strong>MFXMemory_GetSurfaceForXXX</strong> functions.</p>
</div>
<div class="section" id="mfxframesurfaceinterface">
<h2>mfxFrameSurfaceInterface<a class="headerlink" href="#mfxframesurfaceinterface" title="Permalink to this headline">¶</a></h2>
<p>oneVPL API version 2.0 introduces <a class="reference internal" href="../API_ref/VPL_structs_memory.html#_CPPv424mfxFrameSurfaceInterface" title="mfxFrameSurfaceInterface"><code class="xref cpp cpp-struct docutils literal notranslate"><span class="pre">mfxFrameSurfaceInterface</span></code></a>. This
interface is a set of callback functions to manage the lifetime of allocated
surfaces, get access to pixel data, and obtain native handles and device
abstractions (if suitable). Instead of directly accessing
<a class="reference internal" href="../API_ref/VPL_structs_memory.html#_CPPv416mfxFrameSurface1" title="mfxFrameSurface1"><code class="xref cpp cpp-struct docutils literal notranslate"><span class="pre">mfxFrameSurface1</span></code></a> structure members, it’s recommended to use
the <a class="reference internal" href="../API_ref/VPL_structs_memory.html#_CPPv424mfxFrameSurfaceInterface" title="mfxFrameSurfaceInterface"><code class="xref cpp cpp-struct docutils literal notranslate"><span class="pre">mfxFrameSurfaceInterface</span></code></a> if present or call external
allocator callback functions if set.</p>
<p>The following pseudo code shows the usage of <a class="reference internal" href="../API_ref/VPL_structs_memory.html#_CPPv424mfxFrameSurfaceInterface" title="mfxFrameSurfaceInterface"><code class="xref cpp cpp-struct docutils literal notranslate"><span class="pre">mfxFrameSurfaceInterface</span></code></a>
for memory sharing:</p>
<div class="highlight-c++ notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// lets decode frame and try to access output in a an optimal way.</span>
<span class="n">sts</span> <span class="o">=</span> <span class="n">MFXVideoDECODE_DecodeFrameAsync</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">outsurface</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">syncp</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">MFX_ERR_NONE</span> <span class="o">==</span> <span class="n">sts</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">outsurface</span><span class="o">-&gt;</span><span class="n">FrameInterface</span><span class="o">-&gt;</span><span class="n">GetDeviceHandle</span><span class="p">(</span><span class="n">outsurface</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">device_handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">device_type</span><span class="p">);</span>
    <span class="c1">// if application or component is familar with mfxHandleType and it&#39;s possible to share memory created by device_handle.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">isDeviceTypeCompatible</span><span class="p">(</span><span class="n">device_type</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">isPossibleForMemorySharing</span><span class="p">(</span><span class="n">device_handle</span><span class="p">))</span> <span class="p">{</span>
        <span class="c1">// get native handle and type</span>
        <span class="n">outsurface</span><span class="o">-&gt;</span><span class="n">FrameInterface</span><span class="o">-&gt;</span><span class="n">GetNativeHandle</span><span class="p">(</span><span class="n">outsurface</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">resource</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">resource_type</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">isResourceTypeCompatible</span><span class="p">(</span><span class="n">resource_type</span><span class="p">))</span> <span class="p">{</span>
            <span class="c1">//use memory directly</span>
            <span class="n">ProcessNativeMemory</span><span class="p">(</span><span class="n">resource</span><span class="p">);</span>
            <span class="n">outsurface</span><span class="o">-&gt;</span><span class="n">FrameInterface</span><span class="o">-&gt;</span><span class="n">Release</span><span class="p">(</span><span class="n">outsurface</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1">// Application or component is not aware about such DeviceHandle or Resource type need to map to system memory.</span>
    <span class="n">outsurface</span><span class="o">-&gt;</span><span class="n">FrameInterface</span><span class="o">-&gt;</span><span class="n">Map</span><span class="p">(</span><span class="n">outsurface</span><span class="p">,</span> <span class="n">MFX_MAP_READ</span><span class="p">);</span>
    <span class="n">ProcessSystemMemory</span><span class="p">(</span><span class="n">outsurface</span><span class="p">);</span>
    <span class="n">outsurface</span><span class="o">-&gt;</span><span class="n">FrameInterface</span><span class="o">-&gt;</span><span class="n">Unmap</span><span class="p">(</span><span class="n">outsurface</span><span class="p">);</span>
    <span class="n">outsurface</span><span class="o">-&gt;</span><span class="n">FrameInterface</span><span class="o">-&gt;</span><span class="n">Release</span><span class="p">(</span><span class="n">outsurface</span><span class="p">);</span>
<span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="VPL_prg_err.html" class="btn btn-neutral float-right" title="Hardware Device Error Handling" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="VPL_prg_hw.html" class="btn btn-neutral float-left" title="Hardware Acceleration" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, Intel Corporation

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>